<!doctype html>
<html>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width initial-scale=1'>

    <link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext'
          rel='stylesheet' type='text/css'/>
    <style type='text/css'>html {
        overflow-x: initial !important;
    }

    :root {
        --bg-color: #ffffff;
        --text-color: #333333;
        --select-text-bg-color: #B5D6FC;
        --select-text-font-color: auto;
        --monospace: "Lucida Console", Consolas, "Courier", monospace;
        --title-bar-height: 20px;
    }

    .mac-os-11 {
        --title-bar-height: 28px;
    }

    html {
        font-size: 14px;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
    }

    body {
        margin: 0px;
        padding: 0px;
        height: auto;
        inset: 0px;
        font-size: 1rem;
        line-height: 1.42857;
        overflow-x: hidden;
        background: inherit;
        tab-size: 4;
    }

    iframe {
        margin: auto;
    }

    a.url {
        word-break: break-all;
    }

    a:active, a:hover {
        outline: 0px;
    }

    .in-text-selection, ::selection {
        text-shadow: none;
        background: var(--select-text-bg-color);
        color: var(--select-text-font-color);
    }

    #write {
        margin: 0px auto;
        height: auto;
        width: inherit;
        word-break: normal;
        overflow-wrap: break-word;
        position: relative;
        white-space: normal;
        overflow-x: visible;
        padding-top: 36px;
    }

    #write.first-line-indent p {
        text-indent: 2em;
    }

    #write.first-line-indent li p, #write.first-line-indent p * {
        text-indent: 0px;
    }

    #write.first-line-indent li {
        margin-left: 2em;
    }

    .for-image #write {
        padding-left: 8px;
        padding-right: 8px;
    }

    body.typora-export {
        padding-left: 30px;
        padding-right: 30px;
    }

    .typora-export .footnote-line, .typora-export li, .typora-export p {
        white-space: pre-wrap;
    }

    .typora-export .task-list-item input {
        pointer-events: none;
    }

    @media screen and (max-width: 500px) {
        body.typora-export {
            padding-left: 0px;
            padding-right: 0px;
        }

        #write {
            padding-left: 20px;
            padding-right: 20px;
        }

        .CodeMirror-sizer {
            margin-left: 0px !important;
        }

        .CodeMirror-gutters {
            display: none !important;
        }
    }

    #write li > figure:last-child {
        margin-bottom: 0.5rem;
    }

    #write ol, #write ul {
        position: relative;
    }

    img {
        max-width: 100%;
        vertical-align: middle;
        image-orientation: from-image;
    }

    button, input, select, textarea {
        color: inherit;
        font: inherit;
    }

    input[type="checkbox"], input[type="radio"] {
        line-height: normal;
        padding: 0px;
    }

    *, ::after, ::before {
        box-sizing: border-box;
    }

    #write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre {
        width: inherit;
    }

    #write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p {
        position: relative;
    }

    p {
        line-height: inherit;
    }

    h1, h2, h3, h4, h5, h6 {
        break-after: avoid-page;
        break-inside: avoid;
        orphans: 4;
    }

    p {
        orphans: 4;
    }

    h1 {
        font-size: 2rem;
    }

    h2 {
        font-size: 1.8rem;
    }

    h3 {
        font-size: 1.6rem;
    }

    h4 {
        font-size: 1.4rem;
    }

    h5 {
        font-size: 1.2rem;
    }

    h6 {
        font-size: 1rem;
    }

    .md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p {
        margin-top: 1rem;
        margin-bottom: 1rem;
    }

    .hidden {
        display: none;
    }

    .md-blockmeta {
        color: rgb(204, 204, 204);
        font-weight: 700;
        font-style: italic;
    }

    a {
        cursor: pointer;
    }

    sup.md-footnote {
        padding: 2px 4px;
        background-color: rgba(238, 238, 238, 0.7);
        color: rgb(85, 85, 85);
        border-radius: 4px;
        cursor: pointer;
    }

    sup.md-footnote a, sup.md-footnote a:hover {
        color: inherit;
        text-transform: inherit;
        text-decoration: inherit;
    }

    #write input[type="checkbox"] {
        cursor: pointer;
        width: inherit;
        height: inherit;
    }

    figure {
        overflow-x: auto;
        margin: 1.2em 0px;
        max-width: calc(100% + 16px);
        padding: 0px;
    }

    figure > table {
        margin: 0px;
    }

    tr {
        break-inside: avoid;
        break-after: auto;
    }

    thead {
        display: table-header-group;
    }

    table {
        border-collapse: collapse;
        border-spacing: 0px;
        width: 100%;
        overflow: auto;
        break-inside: auto;
        text-align: left;
    }

    table.md-table td {
        min-width: 32px;
    }

    .CodeMirror-gutters {
        border-right: 0px;
        background-color: inherit;
    }

    .CodeMirror-linenumber {
        user-select: none;
    }

    .CodeMirror {
        text-align: left;
    }

    .CodeMirror-placeholder {
        opacity: 0.3;
    }

    .CodeMirror pre {
        padding: 0px 4px;
    }

    .CodeMirror-lines {
        padding: 0px;
    }

    div.hr:focus {
        cursor: none;
    }

    #write pre {
        white-space: pre-wrap;
    }

    #write.fences-no-line-wrapping pre {
        white-space: pre;
    }

    #write pre.ty-contain-cm {
        white-space: normal;
    }

    .CodeMirror-gutters {
        margin-right: 4px;
    }

    .md-fences {
        font-size: 0.9rem;
        display: block;
        break-inside: avoid;
        text-align: left;
        overflow: visible;
        white-space: pre;
        background: inherit;
        position: relative !important;
    }

    .md-fences-adv-panel {
        width: 100%;
        margin-top: 10px;
        text-align: center;
        padding-top: 0px;
        padding-bottom: 8px;
        overflow-x: auto;
    }

    #write .md-fences.mock-cm {
        white-space: pre-wrap;
    }

    .md-fences.md-fences-with-lineno {
        padding-left: 0px;
    }

    #write.fences-no-line-wrapping .md-fences.mock-cm {
        white-space: pre;
        overflow-x: auto;
    }

    .md-fences.mock-cm.md-fences-with-lineno {
        padding-left: 8px;
    }

    .CodeMirror-line, twitterwidget {
        break-inside: avoid;
    }

    .footnotes {
        opacity: 0.8;
        font-size: 0.9rem;
        margin-top: 1em;
        margin-bottom: 1em;
    }

    .footnotes + .footnotes {
        margin-top: 0px;
    }

    .md-reset {
        margin: 0px;
        padding: 0px;
        border: 0px;
        outline: 0px;
        vertical-align: top;
        background: 0px 0px;
        text-decoration: none;
        text-shadow: none;
        float: none;
        position: static;
        width: auto;
        height: auto;
        white-space: nowrap;
        cursor: inherit;
        -webkit-tap-highlight-color: transparent;
        line-height: normal;
        font-weight: 400;
        text-align: left;
        box-sizing: content-box;
        direction: ltr;
    }

    li div {
        padding-top: 0px;
    }

    blockquote {
        margin: 1rem 0px;
    }

    li .mathjax-block, li p {
        margin: 0.5rem 0px;
    }

    li blockquote {
        margin: 1rem 0px;
    }

    li {
        margin: 0px;
        position: relative;
    }

    blockquote > :last-child {
        margin-bottom: 0px;
    }

    blockquote > :first-child, li > :first-child {
        margin-top: 0px;
    }

    .footnotes-area {
        color: rgb(136, 136, 136);
        margin-top: 0.714rem;
        padding-bottom: 0.143rem;
        white-space: normal;
    }

    #write .footnote-line {
        white-space: pre-wrap;
    }

    @media print {
        body, html {
            border: 1px solid transparent;
            height: 99%;
            break-after: avoid;
            break-before: avoid;
            font-variant-ligatures: no-common-ligatures;
        }

        #write {
            margin-top: 0px;
            padding-top: 0px;
            border-color: transparent !important;
        }

        .typora-export * {
            -webkit-print-color-adjust: exact;
        }

        .typora-export #write {
            break-after: avoid;
        }

        .typora-export #write::after {
            height: 0px;
        }

        .is-mac table {
            break-inside: avoid;
        }

        .typora-export-show-outline .typora-export-sidebar {
            display: none;
        }
    }

    .footnote-line {
        margin-top: 0.714em;
        font-size: 0.7em;
    }

    a img, img a {
        cursor: pointer;
    }

    pre.md-meta-block {
        font-size: 0.8rem;
        min-height: 0.8rem;
        white-space: pre-wrap;
        background: rgb(204, 204, 204);
        display: block;
        overflow-x: hidden;
    }

    p > .md-image:only-child:not(.md-img-error) img, p > img:only-child {
        display: block;
        margin: auto;
    }

    #write.first-line-indent p > .md-image:only-child:not(.md-img-error) img {
        left: -2em;
        position: relative;
    }

    p > .md-image:only-child {
        display: inline-block;
        width: 100%;
    }

    #write .MathJax_Display {
        margin: 0.8em 0px 0px;
    }

    .md-math-block {
        width: 100%;
    }

    .md-math-block:not(:empty)::after {
        display: none;
    }

    .MathJax_ref {
        fill: currentcolor;
    }

    [contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus {
        outline: 0px;
        box-shadow: none;
    }

    .md-task-list-item {
        position: relative;
        list-style-type: none;
    }

    .task-list-item.md-task-list-item {
        padding-left: 0px;
    }

    .md-task-list-item > input {
        position: absolute;
        top: 0px;
        left: 0px;
        margin-left: -1.2em;
        margin-top: calc(1em - 10px);
        border: none;
    }

    .math {
        font-size: 1rem;
    }

    .md-toc {
        min-height: 3.58rem;
        position: relative;
        font-size: 0.9rem;
        border-radius: 10px;
    }

    .md-toc-content {
        position: relative;
        margin-left: 0px;
    }

    .md-toc-content::after, .md-toc::after {
        display: none;
    }

    .md-toc-item {
        display: block;
        color: rgb(65, 131, 196);
    }

    .md-toc-item a {
        text-decoration: none;
    }

    .md-toc-inner:hover {
        text-decoration: underline;
    }

    .md-toc-inner {
        display: inline-block;
        cursor: pointer;
    }

    .md-toc-h1 .md-toc-inner {
        margin-left: 0px;
        font-weight: 700;
    }

    .md-toc-h2 .md-toc-inner {
        margin-left: 2em;
    }

    .md-toc-h3 .md-toc-inner {
        margin-left: 4em;
    }

    .md-toc-h4 .md-toc-inner {
        margin-left: 6em;
    }

    .md-toc-h5 .md-toc-inner {
        margin-left: 8em;
    }

    .md-toc-h6 .md-toc-inner {
        margin-left: 10em;
    }

    @media screen and (max-width: 48em) {
        .md-toc-h3 .md-toc-inner {
            margin-left: 3.5em;
        }

        .md-toc-h4 .md-toc-inner {
            margin-left: 5em;
        }

        .md-toc-h5 .md-toc-inner {
            margin-left: 6.5em;
        }

        .md-toc-h6 .md-toc-inner {
            margin-left: 8em;
        }
    }

    a.md-toc-inner {
        font-size: inherit;
        font-style: inherit;
        font-weight: inherit;
        line-height: inherit;
    }

    .footnote-line a:not(.reversefootnote) {
        color: inherit;
    }

    .md-attr {
        display: none;
    }

    .md-fn-count::after {
        content: ".";
    }

    code, pre, samp, tt {
        font-family: var(--monospace);
    }

    kbd {
        margin: 0px 0.1em;
        padding: 0.1em 0.6em;
        font-size: 0.8em;
        color: rgb(36, 39, 41);
        background: rgb(255, 255, 255);
        border: 1px solid rgb(173, 179, 185);
        border-radius: 3px;
        box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset;
        white-space: nowrap;
        vertical-align: middle;
    }

    .md-comment {
        color: rgb(162, 127, 3);
        opacity: 0.6;
        font-family: var(--monospace);
    }

    code {
        text-align: left;
        vertical-align: initial;
    }

    a.md-print-anchor {
        white-space: pre !important;
        border-width: initial !important;
        border-style: none !important;
        border-color: initial !important;
        display: inline-block !important;
        position: absolute !important;
        width: 1px !important;
        right: 0px !important;
        outline: 0px !important;
        background: 0px 0px !important;
        text-decoration: initial !important;
        text-shadow: initial !important;
    }

    .os-windows.monocolor-emoji .md-emoji {
        font-family: "Segoe UI Symbol", sans-serif;
    }

    .md-diagram-panel > svg {
        max-width: 100%;
    }

    [lang="flow"] svg, [lang="mermaid"] svg {
        max-width: 100%;
        height: auto;
    }

    [lang="mermaid"] .node text {
        font-size: 1rem;
    }

    table tr th {
        border-bottom: 0px;
    }

    video {
        max-width: 100%;
        display: block;
        margin: 0px auto;
    }

    iframe {
        max-width: 100%;
        width: 100%;
        border: none;
    }

    .highlight td, .highlight tr {
        border: 0px;
    }

    mark {
        background: rgb(255, 255, 0);
        color: rgb(0, 0, 0);
    }

    .md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong {
        color: inherit;
    }

    .md-expand mark .md-meta {
        opacity: 0.3 !important;
    }

    mark .md-meta {
        color: rgb(0, 0, 0);
    }

    @media print {
        .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 {
            break-inside: avoid;
        }
    }

    .md-diagram-panel .messageText {
        stroke: none !important;
    }

    .md-diagram-panel .start-state {
        fill: var(--node-fill);
    }

    .md-diagram-panel .edgeLabel rect {
        opacity: 1 !important;
    }

    .md-fences.md-fences-math {
        font-size: 1em;
    }

    .md-fences-advanced:not(.md-focus) {
        padding: 0px;
        white-space: nowrap;
        border: 0px;
    }

    .md-fences-advanced:not(.md-focus) {
        background: inherit;
    }

    .typora-export-show-outline .typora-export-content {
        max-width: 1440px;
        margin: auto;
        display: flex;
        flex-direction: row;
    }

    .typora-export-sidebar {
        width: 300px;
        font-size: 0.8rem;
        margin-top: 80px;
        margin-right: 18px;
    }

    .typora-export-show-outline #write {
        --webkit-flex: 2;
        flex: 2 1 0%;
    }

    .typora-export-sidebar .outline-content {
        position: fixed;
        top: 0px;
        max-height: 100%;
        overflow: hidden auto;
        padding-bottom: 30px;
        padding-top: 60px;
        width: 300px;
    }

    @media screen and (max-width: 1024px) {
        .typora-export-sidebar, .typora-export-sidebar .outline-content {
            width: 240px;
        }
    }

    @media screen and (max-width: 800px) {
        .typora-export-sidebar {
            display: none;
        }
    }

    .outline-content li, .outline-content ul {
        margin-left: 0px;
        margin-right: 0px;
        padding-left: 0px;
        padding-right: 0px;
        list-style: none;
    }

    .outline-content ul {
        margin-top: 0px;
        margin-bottom: 0px;
    }

    .outline-content strong {
        font-weight: 400;
    }

    .outline-expander {
        width: 1rem;
        height: 1.42857rem;
        position: relative;
        display: table-cell;
        vertical-align: middle;
        cursor: pointer;
        padding-left: 4px;
    }

    .outline-expander::before {
        content: "";
        position: relative;
        font-family: Ionicons;
        display: inline-block;
        font-size: 8px;
        vertical-align: middle;
    }

    .outline-item {
        padding-top: 3px;
        padding-bottom: 3px;
        cursor: pointer;
    }

    .outline-expander:hover::before {
        content: "";
    }

    .outline-h1 > .outline-item {
        padding-left: 0px;
    }

    .outline-h2 > .outline-item {
        padding-left: 1em;
    }

    .outline-h3 > .outline-item {
        padding-left: 2em;
    }

    .outline-h4 > .outline-item {
        padding-left: 3em;
    }

    .outline-h5 > .outline-item {
        padding-left: 4em;
    }

    .outline-h6 > .outline-item {
        padding-left: 5em;
    }

    .outline-label {
        cursor: pointer;
        display: table-cell;
        vertical-align: middle;
        text-decoration: none;
        color: inherit;
    }

    .outline-label:hover {
        text-decoration: underline;
    }

    .outline-item:hover {
        border-color: rgb(245, 245, 245);
        background-color: var(--item-hover-bg-color);
    }

    .outline-item:hover {
        margin-left: -28px;
        margin-right: -28px;
        border-left: 28px solid transparent;
        border-right: 28px solid transparent;
    }

    .outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before {
        display: none;
    }

    .outline-item-open > .outline-item > .outline-expander::before {
        content: "";
    }

    .outline-children {
        display: none;
    }

    .info-panel-tab-wrapper {
        display: none;
    }

    .outline-item-open > .outline-children {
        display: block;
    }

    .typora-export .outline-item {
        padding-top: 1px;
        padding-bottom: 1px;
    }

    .typora-export .outline-item:hover {
        margin-right: -8px;
        border-right: 8px solid transparent;
    }

    .typora-export .outline-expander::before {
        content: "+";
        font-family: inherit;
        top: -1px;
    }

    .typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before {
        content: "−";
    }

    .typora-export-collapse-outline .outline-children {
        display: none;
    }

    .typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children {
        display: block;
    }

    .typora-export-no-collapse-outline .outline-expander::before {
        content: "" !important;
    }

    .typora-export-show-outline .outline-item-active > .outline-item .outline-label {
        font-weight: 700;
    }

    .md-inline-math-container mjx-container {
        zoom: 0.95;
    }


    .CodeMirror {
        height: auto;
    }

    .CodeMirror.cm-s-inner {
        background: inherit;
    }

    .CodeMirror-scroll {
        overflow: auto hidden;
        z-index: 3;
    }

    .CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler {
        background-color: rgb(255, 255, 255);
    }

    .CodeMirror-gutters {
        border-right: 1px solid rgb(221, 221, 221);
        background: inherit;
        white-space: nowrap;
    }

    .CodeMirror-linenumber {
        padding: 0px 3px 0px 5px;
        text-align: right;
        color: rgb(153, 153, 153);
    }

    .cm-s-inner .cm-keyword {
        color: rgb(119, 0, 136);
    }

    .cm-s-inner .cm-atom, .cm-s-inner.cm-atom {
        color: rgb(34, 17, 153);
    }

    .cm-s-inner .cm-number {
        color: rgb(17, 102, 68);
    }

    .cm-s-inner .cm-def {
        color: rgb(0, 0, 255);
    }

    .cm-s-inner .cm-variable {
        color: rgb(0, 0, 0);
    }

    .cm-s-inner .cm-variable-2 {
        color: rgb(0, 85, 170);
    }

    .cm-s-inner .cm-variable-3 {
        color: rgb(0, 136, 85);
    }

    .cm-s-inner .cm-string {
        color: rgb(170, 17, 17);
    }

    .cm-s-inner .cm-property {
        color: rgb(0, 0, 0);
    }

    .cm-s-inner .cm-operator {
        color: rgb(152, 26, 26);
    }

    .cm-s-inner .cm-comment, .cm-s-inner.cm-comment {
        color: rgb(170, 85, 0);
    }

    .cm-s-inner .cm-string-2 {
        color: rgb(255, 85, 0);
    }

    .cm-s-inner .cm-meta {
        color: rgb(85, 85, 85);
    }

    .cm-s-inner .cm-qualifier {
        color: rgb(85, 85, 85);
    }

    .cm-s-inner .cm-builtin {
        color: rgb(51, 0, 170);
    }

    .cm-s-inner .cm-bracket {
        color: rgb(153, 153, 119);
    }

    .cm-s-inner .cm-tag {
        color: rgb(17, 119, 0);
    }

    .cm-s-inner .cm-attribute {
        color: rgb(0, 0, 204);
    }

    .cm-s-inner .cm-header, .cm-s-inner.cm-header {
        color: rgb(0, 0, 255);
    }

    .cm-s-inner .cm-quote, .cm-s-inner.cm-quote {
        color: rgb(0, 153, 0);
    }

    .cm-s-inner .cm-hr, .cm-s-inner.cm-hr {
        color: rgb(153, 153, 153);
    }

    .cm-s-inner .cm-link, .cm-s-inner.cm-link {
        color: rgb(0, 0, 204);
    }

    .cm-negative {
        color: rgb(221, 68, 68);
    }

    .cm-positive {
        color: rgb(34, 153, 34);
    }

    .cm-header, .cm-strong {
        font-weight: 700;
    }

    .cm-del {
        text-decoration: line-through;
    }

    .cm-em {
        font-style: italic;
    }

    .cm-link {
        text-decoration: underline;
    }

    .cm-error {
        color: red;
    }

    .cm-invalidchar {
        color: red;
    }

    .cm-constant {
        color: rgb(38, 139, 210);
    }

    .cm-defined {
        color: rgb(181, 137, 0);
    }

    div.CodeMirror span.CodeMirror-matchingbracket {
        color: rgb(0, 255, 0);
    }

    div.CodeMirror span.CodeMirror-nonmatchingbracket {
        color: rgb(255, 34, 34);
    }

    .cm-s-inner .CodeMirror-activeline-background {
        background: inherit;
    }

    .CodeMirror {
        position: relative;
        overflow: hidden;
    }

    .CodeMirror-scroll {
        height: 100%;
        outline: 0px;
        position: relative;
        box-sizing: content-box;
        background: inherit;
    }

    .CodeMirror-sizer {
        position: relative;
    }

    .CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar {
        position: absolute;
        z-index: 6;
        display: none;
        outline: 0px;
    }

    .CodeMirror-vscrollbar {
        right: 0px;
        top: 0px;
        overflow: hidden;
    }

    .CodeMirror-hscrollbar {
        bottom: 0px;
        left: 0px;
        overflow: auto hidden;
    }

    .CodeMirror-scrollbar-filler {
        right: 0px;
        bottom: 0px;
    }

    .CodeMirror-gutter-filler {
        left: 0px;
        bottom: 0px;
    }

    .CodeMirror-gutters {
        position: absolute;
        left: 0px;
        top: 0px;
        padding-bottom: 10px;
        z-index: 3;
        overflow-y: hidden;
    }

    .CodeMirror-gutter {
        white-space: normal;
        height: 100%;
        box-sizing: content-box;
        padding-bottom: 30px;
        margin-bottom: -32px;
        display: inline-block;
    }

    .CodeMirror-gutter-wrapper {
        position: absolute;
        z-index: 4;
        background: 0px 0px !important;
        border: none !important;
    }

    .CodeMirror-gutter-background {
        position: absolute;
        top: 0px;
        bottom: 0px;
        z-index: 4;
    }

    .CodeMirror-gutter-elt {
        position: absolute;
        cursor: default;
        z-index: 4;
    }

    .CodeMirror-lines {
        cursor: text;
    }

    .CodeMirror pre {
        border-radius: 0px;
        border-width: 0px;
        background: 0px 0px;
        font-family: inherit;
        font-size: inherit;
        margin: 0px;
        white-space: pre;
        overflow-wrap: normal;
        color: inherit;
        z-index: 2;
        position: relative;
        overflow: visible;
    }

    .CodeMirror-wrap pre {
        overflow-wrap: break-word;
        white-space: pre-wrap;
        word-break: normal;
    }

    .CodeMirror-code pre {
        border-right: 30px solid transparent;
        width: fit-content;
    }

    .CodeMirror-wrap .CodeMirror-code pre {
        border-right: none;
        width: auto;
    }

    .CodeMirror-linebackground {
        position: absolute;
        inset: 0px;
        z-index: 0;
    }

    .CodeMirror-linewidget {
        position: relative;
        z-index: 2;
        overflow: auto;
    }

    .CodeMirror-wrap .CodeMirror-scroll {
        overflow-x: hidden;
    }

    .CodeMirror-measure {
        position: absolute;
        width: 100%;
        height: 0px;
        overflow: hidden;
        visibility: hidden;
    }

    .CodeMirror-measure pre {
        position: static;
    }

    .CodeMirror div.CodeMirror-cursor {
        position: absolute;
        visibility: hidden;
        border-right: none;
        width: 0px;
    }

    .CodeMirror div.CodeMirror-cursor {
        visibility: hidden;
    }

    .CodeMirror-focused div.CodeMirror-cursor {
        visibility: inherit;
    }

    .cm-searching {
        background: rgba(255, 255, 0, 0.4);
    }

    span.cm-underlined {
        text-decoration: underline;
    }

    span.cm-strikethrough {
        text-decoration: line-through;
    }

    .cm-tw-syntaxerror {
        color: rgb(255, 255, 255);
        background-color: rgb(153, 0, 0);
    }

    .cm-tw-deleted {
        text-decoration: line-through;
    }

    .cm-tw-header5 {
        font-weight: 700;
    }

    .cm-tw-listitem:first-child {
        padding-left: 10px;
    }

    .cm-tw-box {
        border-style: solid;
        border-right-width: 1px;
        border-bottom-width: 1px;
        border-left-width: 1px;
        border-color: inherit;
        border-top-width: 0px !important;
    }

    .cm-tw-underline {
        text-decoration: underline;
    }

    @media print {
        .CodeMirror div.CodeMirror-cursor {
            visibility: hidden;
        }
    }


    :root {
        --side-bar-bg-color: #fafafa;
        --control-text-color: #777;
    }

    @include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

    /* open-sans-regular - latin-ext_latin */
    /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
    html {
        font-size: 16px;
        -webkit-font-smoothing: antialiased;
    }

    body {
        font-family: "Open Sans", "Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
        color: rgb(51, 51, 51);
        line-height: 1.6;
    }

    #write {
        max-width: 860px;
        margin: 0 auto;
        padding: 30px;
        padding-bottom: 100px;
    }

    @media only screen and (min-width: 1400px) {
        #write {
            max-width: 1024px;
        }
    }

    @media only screen and (min-width: 1800px) {
        #write {
            max-width: 1200px;
        }
    }

    #write > ul:first-child,
    #write > ol:first-child {
        margin-top: 30px;
    }

    a {
        color: #4183C4;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        position: relative;
        margin-top: 1rem;
        margin-bottom: 1rem;
        font-weight: bold;
        line-height: 1.4;
        cursor: text;
    }

    h1:hover a.anchor,
    h2:hover a.anchor,
    h3:hover a.anchor,
    h4:hover a.anchor,
    h5:hover a.anchor,
    h6:hover a.anchor {
        text-decoration: none;
    }

    h1 tt,
    h1 code {
        font-size: inherit;
    }

    h2 tt,
    h2 code {
        font-size: inherit;
    }

    h3 tt,
    h3 code {
        font-size: inherit;
    }

    h4 tt,
    h4 code {
        font-size: inherit;
    }

    h5 tt,
    h5 code {
        font-size: inherit;
    }

    h6 tt,
    h6 code {
        font-size: inherit;
    }

    h1 {
        font-size: 2.25em;
        line-height: 1.2;
        border-bottom: 1px solid #eee;
    }

    h2 {
        font-size: 1.75em;
        line-height: 1.225;
        border-bottom: 1px solid #eee;
    }

    /*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

    h3 {
        font-size: 1.5em;
        line-height: 1.43;
    }

    h4 {
        font-size: 1.25em;
    }

    h5 {
        font-size: 1em;
    }

    h6 {
        font-size: 1em;
        color: #777;
    }

    p,
    blockquote,
    ul,
    ol,
    dl,
    table {
        margin: 0.8em 0;
    }

    li > ol,
    li > ul {
        margin: 0 0;
    }

    hr {
        height: 2px;
        padding: 0;
        margin: 16px 0;
        background-color: #e7e7e7;
        border: 0 none;
        overflow: hidden;
        box-sizing: content-box;
    }

    li p.first {
        display: inline-block;
    }

    ul,
    ol {
        padding-left: 30px;
    }

    ul:first-child,
    ol:first-child {
        margin-top: 0;
    }

    ul:last-child,
    ol:last-child {
        margin-bottom: 0;
    }

    blockquote {
        border-left: 4px solid #dfe2e5;
        padding: 0 15px;
        color: #777777;
    }

    blockquote blockquote {
        padding-right: 0;
    }

    table {
        padding: 0;
        word-break: initial;
    }

    table tr {
        border: 1px solid #dfe2e5;
        margin: 0;
        padding: 0;
    }

    table tr:nth-child(2n),
    thead {
        background-color: #f8f8f8;
    }

    table th {
        font-weight: bold;
        border: 1px solid #dfe2e5;
        border-bottom: 0;
        margin: 0;
        padding: 6px 13px;
    }

    table td {
        border: 1px solid #dfe2e5;
        margin: 0;
        padding: 6px 13px;
    }

    table th:first-child,
    table td:first-child {
        margin-top: 0;
    }

    table th:last-child,
    table td:last-child {
        margin-bottom: 0;
    }

    .CodeMirror-lines {
        padding-left: 4px;
    }

    .code-tooltip {
        box-shadow: 0 1px 1px 0 rgba(0, 28, 36, .3);
        border-top: 1px solid #eef2f2;
    }

    .md-fences,
    code,
    tt {
        border: 1px solid #e7eaed;
        background-color: #f8f8f8;
        border-radius: 3px;
        padding: 0;
        padding: 2px 4px 0px 4px;
        font-size: 0.9em;
    }

    code {
        background-color: #f3f4f4;
        padding: 0 2px 0 2px;
    }

    .md-fences {
        margin-bottom: 15px;
        margin-top: 15px;
        padding-top: 8px;
        padding-bottom: 6px;
    }


    .md-task-list-item > input {
        margin-left: -1.3em;
    }

    @media print {
        html {
            font-size: 13px;
        }

        table,
        pre {
            page-break-inside: avoid;
        }

        pre {
            word-wrap: break-word;
        }
    }

    .md-fences {
        background-color: #f8f8f8;
    }

    #write pre.md-meta-block {
        padding: 1rem;
        font-size: 85%;
        line-height: 1.45;
        background-color: #f7f7f7;
        border: 0;
        border-radius: 3px;
        color: #777777;
        margin-top: 0 !important;
    }

    .mathjax-block > .code-tooltip {
        bottom: .375rem;
    }

    .md-mathjax-midline {
        background: #fafafa;
    }

    #write > h3.md-focus:before {
        left: -1.5625rem;
        top: .375rem;
    }

    #write > h4.md-focus:before {
        left: -1.5625rem;
        top: .285714286rem;
    }

    #write > h5.md-focus:before {
        left: -1.5625rem;
        top: .285714286rem;
    }

    #write > h6.md-focus:before {
        left: -1.5625rem;
        top: .285714286rem;
    }

    .md-image > .md-meta {
        /*border: 1px solid #ddd;*/
        border-radius: 3px;
        padding: 2px 0px 0px 4px;
        font-size: 0.9em;
        color: inherit;
    }

    .md-tag {
        color: #a7a7a7;
        opacity: 1;
    }

    .md-toc {
        margin-top: 20px;
        padding-bottom: 20px;
    }

    .sidebar-tabs {
        border-bottom: none;
    }

    #typora-quick-open {
        border: 1px solid #ddd;
        background-color: #f8f8f8;
    }

    #typora-quick-open-item {
        background-color: #FAFAFA;
        border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
        border-style: solid;
        border-width: 1px;
    }

    /** focus mode */
    .on-focus-mode blockquote {
        border-left-color: rgba(85, 85, 85, 0.12);
    }

    header, .context-menu, .megamenu-content, footer {
        font-family: "Segoe UI", "Arial", sans-serif;
    }

    .file-node-content:hover .file-node-icon,
    .file-node-content:hover .file-node-open-state {
        visibility: visible;
    }

    .mac-seamless-mode #typora-sidebar {
        background-color: #fafafa;
        background-color: var(--side-bar-bg-color);
    }

    .md-lang {
        color: #b4654d;
    }

    /*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

    #md-notification .btn {
        border: 0;
    }

    .dropdown-menu .divider {
        border-color: #e5e5e5;
        opacity: 0.4;
    }

    .ty-preferences .window-content {
        background-color: #fafafa;
    }

    .ty-preferences .nav-group-item.active {
        color: white;
        background: #999;
    }

    .menu-item-container a.menu-style-btn {
        background-color: #f5f8fa;
        background-image: linear-gradient(180deg, hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0));
    }


    </style>
    <title>redis实战学习笔记</title>
</head>
<body class='typora-export os-windows'>
<div class='typora-export-content'>
    <div id='write' class=''><h1 id='--redis实战学习笔记--'><span>--redis实战学习笔记--</span></h1>
        <h1 id='登录-1'><span>登录</span></h1>
        <h2 id='基于redis实现登录功能'><span>基于redis实现登录功能</span></h2>
        <h3 id='发送验证码'><span>发送验证码</span></h3>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@Override</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span
                class="cm-def">sendCode</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">phone</span>, <span class="cm-variable">HttpSession</span> <span
                class="cm-variable">session</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//验证手机号</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">RegexUtils</span>.<span class="cm-variable">isPhoneInvalid</span>(<span
                class="cm-variable">phone</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//验证不通过，返回错误提示</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">debug</span>(<span class="cm-string">"验证码错误....."</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"手机号错误，请重新填写"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//验证通过，生成验证码</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//6位数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">code</span> <span
                class="cm-operator">=</span> <span class="cm-variable">RandomUtil</span>.<span class="cm-variable">randomNumbers</span>(<span
                class="cm-number">6</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//保存验证码到redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">opsForValue</span>().<span
                class="cm-variable">set</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">LOGIN_CODE_KEY</span> <span class="cm-operator">+</span> <span class="cm-variable">phone</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">code</span>, <span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">LOGIN_CODE_TTL</span>, <span class="cm-variable">TimeUnit</span>.<span
                class="cm-variable">MINUTES</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//发送验证码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">log</span>.<span
                class="cm-variable">debug</span>(<span class="cm-string">"验证码发送成功,"</span> <span
                class="cm-operator">+</span> <span class="cm-variable">code</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回响应</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Result</span>.<span class="cm-variable">ok</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 483px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 483px;"></div></div></div></pre>
        <h3 id='登录-2'><span>登录</span></h3>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div
                class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div
                style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div
                class="CodeMirror-activeline" style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-meta">@Override</span></span></pre></div><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span
                class="cm-def">login</span>(<span class="cm-variable">LoginFormDTO</span> <span class="cm-variable">loginForm</span>, <span
                class="cm-variable">HttpSession</span> <span class="cm-variable">session</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断手机号格式是否正确</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">phone</span> <span
                class="cm-operator">=</span> <span class="cm-variable">loginForm</span>.<span class="cm-variable">getPhone</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">RegexUtils</span>.<span class="cm-variable">isPhoneInvalid</span>(<span
                class="cm-variable">phone</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//如果不正确则直接返回错误</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">debug</span>(<span
                class="cm-string">"手机号:"</span> <span class="cm-operator">+</span> <span
                class="cm-variable">phone</span> <span class="cm-operator">+</span> <span class="cm-string">"错误"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"手机号格式错误"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断验证码是否一致，redis中对比</span></span></pre><pre class=" CodeMirror-line "
                                                                                role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//String cacheCode = session.getAttribute("code").toString();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">cacheCode</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">LOGIN_CODE_KEY</span> <span class="cm-operator">+</span> <span class="cm-variable">phone</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">code</span> <span
                class="cm-operator">=</span> <span class="cm-variable">loginForm</span>.<span class="cm-variable">getCode</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//如果验证码为空，或者不一致，则返回验证码错误</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">code</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span> <span class="cm-operator">||</span> <span
                class="cm-variable">code</span>.<span class="cm-variable">length</span>() <span
                class="cm-operator">==</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"验证码不能为空"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断验证码是否为6位数</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">code</span>.<span
                class="cm-variable">length</span>() <span class="cm-operator">!=</span> <span class="cm-number">6</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"验证码长度不正确"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断验证码是否正确</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span
                class="cm-variable">code</span>.<span class="cm-variable">equals</span>(<span class="cm-variable">cacheCode</span>))</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//验证码错误</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"验证码错误"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//验证码输入正确</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断用户是否存在</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">User</span> <span class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">query</span>().<span class="cm-variable">eq</span>(<span
                class="cm-string">"phone"</span>, <span class="cm-variable">phone</span>).<span
                class="cm-variable">one</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//如果用户不存在则创建用户，保存到数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">user</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建用户，保存到数据库</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">createUser</span>(<span class="cm-variable">phone</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//如果用户存在，保存到redis</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//session.setAttribute("user", user);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成token，作为登录令牌</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">token</span> <span
                class="cm-operator">=</span> <span class="cm-variable">UUID</span>.<span
                class="cm-variable">randomUUID</span>().<span class="cm-variable">toString</span>(<span class="cm-atom">true</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//将User对象转为Hash存储. UserDTO是用户的部分信息</span></span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UserDTO</span> <span
                class="cm-variable">userDTO</span> <span class="cm-operator">=</span> <span
                class="cm-variable">BeanUtil</span>.<span class="cm-variable">copyProperties</span>(<span
                class="cm-variable">user</span>, <span class="cm-variable">UserDTO</span>.<span
                class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//转map</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Map</span><span class="cm-operator">&lt;</span><span
                class="cm-variable-3">String</span>, <span class="cm-variable-3">Object</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">userMap</span> <span class="cm-operator">=</span> <span
                class="cm-variable">BeanUtil</span>.<span class="cm-variable">beanToMap</span>(<span
                class="cm-variable">userDTO</span>, <span class="cm-keyword">new</span> <span class="cm-variable">HashMap</span><span
                class="cm-operator">&lt;&gt;</span>(), <span class="cm-variable">CopyOptions</span>.<span
                class="cm-variable">create</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span
                class="cm-variable">setIgnoreNullValue</span>(<span class="cm-atom">true</span>) <span
                class="cm-comment">// 忽略空的值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span
                class="cm-variable">setFieldValueEditor</span>((<span class="cm-variable">fieldName</span>, <span
                class="cm-variable">fieldVaule</span>) <span class="cm-operator">-&gt;</span> <span class="cm-variable">fieldVaule</span>.<span
                class="cm-variable">toString</span>()));</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存到redis中</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存的key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">tokenKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">LOGIN_USER_KEY</span> <span
                class="cm-operator">+</span> <span class="cm-variable">token</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForHash</span>().<span class="cm-variable">putAll</span>(<span
                class="cm-variable">tokenKey</span>, <span class="cm-variable">userMap</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置有效期</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">expire</span>(<span class="cm-variable">tokenKey</span>, <span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">LOGIN_USER_TTL</span>, <span class="cm-variable">TimeUnit</span>.<span
                class="cm-variable">MINUTES</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回响应，返回token</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Result</span>.<span class="cm-variable">ok</span>(<span
                class="cm-variable">token</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 创建用户，添加到数据库中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param phone 手机号码</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return user</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">User</span> <span class="cm-def">createUser</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">phone</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">User</span> <span
                class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-keyword">new</span> <span class="cm-variable">User</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">user</span>.<span class="cm-variable">setPhone</span>(<span class="cm-variable">phone</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">user</span>.<span class="cm-variable">setNickName</span>(<span class="cm-variable">SystemConstants</span>.<span
                class="cm-variable">USER_NICK_NAME_PREFIX</span> <span class="cm-operator">+</span> <span
                class="cm-variable">RandomUtil</span>.<span class="cm-variable">randomString</span>(<span
                class="cm-number">10</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将用户信息插入到 t_user表中</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">save</span>(<span
                class="cm-variable">user</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//返回数据</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">user</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1794px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1794px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <h2 id='登录校验'><span>登录校验</span></h2>
        <h3 id='登录拦截器'><span>登录拦截器</span></h3>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">LoginInterceptor</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">HandlerInterceptor</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 拦截器校验用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param request  HttpServletRequest</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param response HttpServletResponse</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param handler  Object</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return boolean</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">preHandle</span>(<span
                class="cm-variable">HttpServletRequest</span> <span class="cm-variable">request</span>, <span
                class="cm-variable">HttpServletResponse</span> <span class="cm-variable">response</span>, <span
                class="cm-variable-3">Object</span> <span class="cm-variable">handler</span>) <span class="cm-keyword">throws</span> <span
                class="cm-variable">Exception</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 判断是否拦截,查看ThreadLoad是否有用户</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">UserHolder</span>.<span class="cm-variable">getUser</span>() <span
                class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不存在，拦截，响应401</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">response</span>.<span class="cm-variable">setStatus</span>(<span class="cm-number">401</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//放行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 644px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 644px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <h3 id='刷新token的拦截器'><span>刷新token的拦截器</span></h3>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">RefreshTokenInterceptor</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">HandlerInterceptor</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 构造函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param stringRedisTemplate StringRedisTemplate</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">RefreshTokenInterceptor</span>(<span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>)</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span
                class="cm-variable">stringRedisTemplate</span> <span class="cm-operator">=</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 拦截器刷新token的过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param request  HttpServletRequest</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param response HttpServletResponse</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param handler  Object</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return boolean</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">preHandle</span>(<span
                class="cm-variable">HttpServletRequest</span> <span class="cm-variable">request</span>, <span
                class="cm-variable">HttpServletResponse</span> <span class="cm-variable">response</span>, <span
                class="cm-variable-3">Object</span> <span class="cm-variable">handler</span>) <span class="cm-keyword">throws</span> <span
                class="cm-variable">Exception</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//从请求头里获取token</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">token</span> <span
                class="cm-operator">=</span> <span class="cm-variable">request</span>.<span class="cm-variable">getHeader</span>(<span
                class="cm-string">"authorization"</span>);</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断token是否存在</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">token</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span> <span class="cm-operator">||</span> <span
                class="cm-variable">token</span>.<span class="cm-variable">equals</span>(<span
                class="cm-string">""</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不存在，拦截</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//token存在，根据token获取redisKey</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">LOGIN_USER_KEY</span> <span
                class="cm-operator">+</span> <span class="cm-variable">token</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Map</span><span class="cm-operator">&lt;</span><span
                class="cm-variable-3">Object</span>, <span class="cm-variable-3">Object</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">userMap</span> <span class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForHash</span>().<span class="cm-variable">entries</span>(<span
                class="cm-variable">redisKey</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断用户是否存在，userMap为空</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">userMap</span>.<span
                class="cm-variable">isEmpty</span>())</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不存在，拦截，响应401</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">response</span>.<span class="cm-variable">setStatus</span>(<span class="cm-number">401</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//转实体类</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UserDTO</span> <span class="cm-variable">userDTO</span> <span
                class="cm-operator">=</span> <span class="cm-variable">BeanUtil</span>.<span class="cm-variable">fillBeanWithMap</span>(<span
                class="cm-variable">userMap</span>, <span class="cm-keyword">new</span> <span class="cm-variable">UserDTO</span>(), <span
                class="cm-atom">false</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//保存到ThreadLoad</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UserHolder</span>.<span class="cm-variable">saveUser</span>(<span
                class="cm-variable">BeanUtil</span>.<span class="cm-variable">copyProperties</span>(<span
                class="cm-variable">userDTO</span>, <span class="cm-variable">UserDTO</span>.<span class="cm-keyword">class</span>));</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//刷新过期时间，类似于session机制</span></span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">expire</span>(<span class="cm-variable">redisKey</span>, <span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">LOGIN_USER_TTL</span>, <span class="cm-variable">TimeUnit</span>.<span
                class="cm-variable">MINUTES</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//放行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 渲染之后，返回用户之前。 用户执行完毕后，销毁对应的用户信息</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param request  HttpServletRequest</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param response HttpServletResponse</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param handler  Object</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param ex &nbsp; &nbsp; &nbsp; Exception</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">afterCompletion</span>(<span
                class="cm-variable">HttpServletRequest</span> <span class="cm-variable">request</span>, <span
                class="cm-variable">HttpServletResponse</span> <span class="cm-variable">response</span>, <span
                class="cm-variable-3">Object</span> <span class="cm-variable">handler</span>, <span class="cm-variable">Exception</span> <span
                class="cm-variable">ex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">throws</span> <span class="cm-variable">Exception</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UserHolder</span>.<span class="cm-variable">removeUser</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1656px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1656px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <h3 id='spring-mvc拦截器配置'><span>spring mvc拦截器配置</span></h3>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                                   style="padding-right: 0.1px;"><span
                class="cm-meta">@Configuration</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">SpringMvcConfiguration</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">WebMvcConfigurer</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">addInterceptors</span>(<span
                class="cm-variable">InterceptorRegistry</span> <span class="cm-variable">registry</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//添加拦截器，登录拦截器</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">InterceptorRegistration</span> <span
                class="cm-variable">interceptorRegistration</span> <span class="cm-operator">=</span> <span
                class="cm-variable">registry</span>.<span class="cm-variable">addInterceptor</span>(<span
                class="cm-keyword">new</span> <span class="cm-variable">LoginInterceptor</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 添加配置可以放行哪些路径</span></span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">interceptorRegistration</span>.<span class="cm-variable">excludePathPatterns</span>(</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-string">"/shop/**"</span>,</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-string">"/voucher/**"</span>,</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-string">"/shop-type/**"</span>,</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-string">"/upload/**"</span>,</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-string">"/blog/hot"</span>,</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-string">"/user/code"</span>,</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-string">"/user/login"</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ).<span
                class="cm-variable">order</span>(<span class="cm-number">1</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//刷新token过期时间拦截器</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">InterceptorRegistration</span> <span
                class="cm-variable">refreshTokenInterceptorRegistration</span> <span class="cm-operator">=</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">registry</span>.<span class="cm-variable">addInterceptor</span>(<span
                class="cm-keyword">new</span> <span class="cm-variable">RefreshTokenInterceptor</span>(<span
                class="cm-variable">stringRedisTemplate</span>));</span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">refreshTokenInterceptorRegistration</span>.<span
                class="cm-variable">addPathPatterns</span>(<span class="cm-string">"/**"</span>).<span
                class="cm-variable">order</span>(<span class="cm-number">0</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 667px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 667px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h1 id='商户查询缓存'><span>商户查询缓存</span></h1>
        <p>&nbsp;</p>
        <h2 id='缓存是什么'><span>缓存是什么？</span></h2>
        <p><span>缓存就是数据交换的缓冲区（称作Cache [ kæʃ ] ），是存贮数据的临时地方，一般读写性能较高</span></p>
        <h2 id='缓存的作用'><span>缓存的作用</span></h2>
        <ul>
            <li><span>降低后端负载：当用户进行请求时，先去查询缓存，查询到之后直接返回给用户，而不必查询数据库，大大降低了后端的压力</span></li>
            <li><span>提高读写效率，降低响应时间：数据库的读写是磁盘读写，其响应时间一般比较长，而 Redis 是基于内存的，读写时间快</span></li>
        </ul>
        <h2 id='缓存的成本'><span>缓存的成本</span></h2>
        <ul>
            <li><span>数据一致性成本：当数据库中的数据发生了改变，而缓存中的数据还是旧的数据，当用户从缓存中读取数据时，获取到的依旧是旧的数据</span></li>
            <li><span>代码维护成本：为了解决一致性成本，以及缓存雪崩，缓存击穿等问题，就需要非常复杂的业务编码</span></li>
            <li><span>运维成本：缓存集群的部署维护需要额外的人力成本、硬件成本</span></li>
        </ul>
        <p>&nbsp;</p>
        <h2 id='查询实现'><span>查询实现</span></h2>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span><span
                class="cm-meta">@Override</span></span></pre></div><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span
                class="cm-def">queryById</span>(<span class="cm-variable-3">Long</span> <span
                class="cm-variable">id</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 1、根据 Id 查询 Redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">shopJson</span> <span class="cm-operator">=</span> <span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">opsForValue</span>().<span
                class="cm-variable">get</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">CACHE_SHOP_KEY</span> <span class="cm-operator">+</span> <span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 2、判断 shopJSON 是否为空</span></span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">StrUtil</span>.<span class="cm-variable">isNotBlank</span>(<span
                class="cm-variable">shopJson</span>)) {</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 3、存在，直接返回</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Shop</span> <span class="cm-variable">shop</span> <span class="cm-operator">=</span> <span
                class="cm-variable">JSONUtil</span>.<span class="cm-variable">toBean</span>(<span class="cm-variable">shopJson</span>, <span
                class="cm-variable">Shop</span>.<span class="cm-keyword">class</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">shop</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 4、不存在，查询数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Shop</span> <span
                class="cm-variable">shop</span> <span class="cm-operator">=</span> <span
                class="cm-variable">getById</span>(<span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 5、不存在，返回错误</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span>(<span class="cm-variable">shop</span> <span
                class="cm-operator">==</span> <span class="cm-atom">null</span>){</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"店铺不存在！"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 6、存在，写入 Redis</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">set</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">CACHE_SHOP_KEY</span> <span class="cm-operator">+</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">JSONUtil</span>.<span class="cm-variable">toJsonStr</span>(<span
                class="cm-variable">shop</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 7、返回</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">shop</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 552px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 552px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h2 id='缓存更新策略'><span>缓存更新策略</span></h2>
        <ul>
            <li><span>内存淘汰</span></li>
            <li><span>超时剔除</span></li>
            <li><span>主动更新</span></li>
        </ul>
        <p>&nbsp;</p>
        <ul>
            <li><span>低一致性需求：使用内存淘汰机制。例如店铺类型的查询缓存</span></li>
            <li><span>高一致性需求：主动更新，并以超时剔除作为兜底方案。例如店铺详情查询的缓存</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='主动更新策略'><span>主动更新策略</span></h3>
        <ul>
            <li><span>Cache Aside Pattern：由缓存的调用者，在更新数据库的同时更新缓存，推荐</span></li>
            <li><span>Read/Writer Through Pattern：缓存与数据库整合为一个服务，由服务来维护一致性。调用者调用该服务，无需关心缓存一致性问题。</span></li>
            <li><span>Writer Behind Caching Pattern：调用者只操作缓存，由其他线程异步的将缓存数据持久化到数据库，保证最终一致。</span></li>
        </ul>
        <p>&nbsp;</p>
        <h2 id='更新缓存的三个问题'><span>更新缓存的三个问题</span></h2>
        <p>&nbsp;</p>
        <h3 id='1删除缓存还是更新缓存'><span>1.删除缓存还是更新缓存？</span></h3>
        <ul>
            <li><span>更新缓存：每次更新数据库都更新缓存，无效写操作较多。</span>
                <span>如果我们对数据库做了上百次操作，那么就需要对缓存进行上百次操作，在进行这上百次的操作过程中，如果没有任何的查询操作，也就是写多读少，那么对于缓存的上百次操作都可以看作成是无效的操作。</span>
            </li>
            <li><span>删除操作：更新数据库时让缓存失效，查询时再更新缓存。（一般选择此种方案）</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='2如何保证缓存与数据库的操作的同时成功或失败'><span>2.如何保证缓存与数据库的操作的同时成功或失败？</span></h3>
        <ul>
            <li><span>单体系统：将缓存与数据库操作放在一个事务</span></li>
            <li><span>分布式事务：利用 TCC 等分布式事务方案</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='3先操作缓存还是先操作数据库'><span>3.先操作缓存还是先操作数据库？</span></h3>
        <ul>
            <li><span>先删除缓存，再操作数据库：假设有两个线程：线程1 和 线程2，线程1执行更新操作，先将缓存中的数据删除，然后执行更新数据库操作，由于更新逻辑复杂，执行时间较长，此时线程2 也开始执行，线程2 执行查询操作，由于缓存中的数据被线程 1 删除了，导致查询缓存未命中，于是线程2转而去查询数据库，此时数据库并未完成更新操作，查询出的数据依旧为旧数据，接着程序就将旧数据重新写入到了缓存。这就会导致后续的所有查询操作查询到的数据依旧是旧数据。</span>
            </li>
            <li><span>先操作数据库，再删除缓存：</span>
                <span>情况一：假设有两个线程，线程 1 和线程 2，线程 1 执行更新操作，线程 1 先去更新数据库，然后再删除缓存，由于更新逻辑复杂，执行时间较长，此时线程2 也开始执行，线程 2 执行查询操作，由于此时数据库尚未更新完成，且缓存未被删除，线程 2 依然能从缓存中查询到旧的数据，一旦线程 1 更新数据库完成，且删除了缓存中的数据，那么其他线程再查询时就会无法命中缓存，从而去查询数据库同步缓存数据。这种情况的一个好处就是，即使线程1 未完成数据库的更新，其他线程在查询时依然能够命中缓存，哪怕是旧的缓存，也不会额外浪费时间去查询数据库。而且一旦数据库更新完成，后续的查询便都是最新的数据。情况二：还有一种情况就是当线程 2 执行查询操作时，此时缓存中的数据恰好过期，然后线程 2 便会去数据库中查询，但是此时线程 1 未完成更新操作，所以数据库中还是原先的数据，线程 2 在将旧数据重新写入缓存的同时，恰巧线程 1 完成了数据库更新操作，并将缓存删除，这就导致缓存中的数据一直是旧数据。但实际上这种情况发生的概率极低，为了避免这种情况的发生，可以在写入缓存的时候设置过期时间。</span>
            </li>
        </ul>
        <h2 id='缓存更新策略的最佳实践方案'><span>缓存更新策略的最佳实践方案</span></h2>
        <ul>
            <li><p><span>低一致性需求：使用Redis自带的内存淘汰机制</span></p></li>
            <li><p><span>高一致性需求：主动更新，并以超时剔除作为兜底方案</span></p>
                <p><span>	</span><span> 读操作： • 缓存命中则直接返回 • 缓存未命中则查询数据库，并写入缓存，设定超时时间</span></p>
                <p><span>	</span><span> 写操作： • 先写数据库，然后再删除缓存 • 要确保数据库与缓存操作的原子性</span></p></li>
        </ul>
        <p>&nbsp;</p>
        <h2 id='更新实现'><span>更新实现</span></h2>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span><span
                class="cm-meta">@Override</span></span></pre></div><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span
                class="cm-def">updateShop</span>(<span class="cm-variable">Shop</span> <span
                class="cm-variable">shop</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">id</span> <span class="cm-operator">=</span> <span
                class="cm-variable">shop</span>.<span class="cm-variable">getId</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">id</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"商户id不能为空"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//先更新数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">b</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span
                class="cm-variable">updateById</span>(<span class="cm-variable">shop</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//更新失败，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-operator">!</span><span class="cm-variable">b</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"更新失败"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//更新没有失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//删除redis里的数据，下一次查询时自动添加进redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//redisKey</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">CACHE_SHOP_KEY</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">redisKey</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回响应</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Result</span>.<span class="cm-variable">ok</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 598px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 598px;"></div></div></div></pre>
        <p><span>或者</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span> <span
                class="cm-comment">/**</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 更新数据</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; 要更新的主键</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param data &nbsp; &nbsp; &nbsp; 要更新的对象</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param keyPrefix  redis的key前缀</span></span></pre><pre class=" CodeMirror-line "
                                                                                           role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param dbFallback 更新数据库的函数，返回值要为Boolean类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;T&gt; &nbsp; &nbsp; &nbsp;  要更新的对象的泛型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; 主键的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return boolean</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">T</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable-3">boolean</span> <span class="cm-def">update</span>(<span
                class="cm-variable">ID</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">T</span> <span class="cm-variable">data</span>, <span
                class="cm-variable-3">String</span> <span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">T</span>, <span class="cm-variable-3">Boolean</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">id</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//先更新数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">b</span> <span
                class="cm-operator">=</span> <span class="cm-variable">dbFallback</span>.<span
                class="cm-variable">apply</span>(<span class="cm-variable">data</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//更新失败，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-operator">!</span><span class="cm-variable">b</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//更新没有失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//删除redis里的数据，下一次查询时自动添加进redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//redisKey</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">delete</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回响应</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 782px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 782px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h1 id='缓存问题'><span>缓存问题</span></h1>
        <h2 id='缓存穿透'><span>缓存穿透</span></h2>
        <h3 id='是什么-1'><span>是什么？</span></h3>
        <p><span>缓存穿透是指客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求都会到达数据库。</span>
            <span>如果有恶意用户，使用大量线程并发访问这些不存在的数据，这样所有的请求都会到达数据库，数据库顶不住访问压力，就会崩掉</span></p>
        <h3 id='解决方案-1'><span>解决方案</span></h3><h4 id='缓存空对象'><span>缓存空对象</span></h4>
        <p><span>将数据库中不存在的数据以 null 的形式存储到缓存中。但是这种方式会增加额外的内存消耗，我们可以在缓存 null 的时候，设置过期时间。</span></p>
        <p><span>优点：</span></p>
        <ul>
            <li><span>实现简单，维护方便</span></li>
        </ul>
        <p><span>缺点：</span></p>
        <ul>
            <li><span>额外的内存消耗</span></li>
            <li><span>可能造成短期的不一致</span></li>
        </ul>
        <p>&nbsp;</p><h4 id='布隆过滤'><span>布隆过滤</span></h4>
        <p><span>在客户端与 Redis 之间增加一层过滤，当用户请求来的时候，先去访问布隆过滤器，判断请求的数据是否存在，如果不存在则拒绝请求，如果存在，则放行。</span></p>
        <p><span>优点：</span></p>
        <ul>
            <li><span>内存占用较少，没有多余的 key</span></li>
        </ul>
        <p><span>缺点：</span></p>
        <ul>
            <li><span>实现复杂 </span></li>
            <li><span>存在误判的可能</span></li>
        </ul>
        <p><span>布隆过滤器判断时，如果数据不存在，就是真的不存在，如果判断数据存在，那么有可能不存在。存在一定的穿透风险</span></p>
        <p>&nbsp;</p>
        <h3 id='解决缓存穿透'><span>解决缓存穿透</span></h3>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span><span
                class="cm-comment">/**</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 查询数据，有缓存，解决缓存穿透问题，未解决缓存雪崩问题</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param keyPrefix  redisKey的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param type &nbsp; &nbsp; &nbsp; 返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param dbFallback 查询数据库的函数</span></span></pre><pre class=" CodeMirror-line "
                                                                                        role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param expireTime 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; 时间单位</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param &lt;R&gt; &nbsp; &nbsp; &nbsp;  返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; id的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 泛型R</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">R</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">R</span> <span class="cm-def">queryWithPassThrough</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable">ID</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">type</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">ID</span>, <span class="cm-variable">R</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>, <span
                class="cm-variable-3">Long</span> <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">TimeUnit</span> <span class="cm-variable">timeUnit</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得前缀</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查询redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">json</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">StrUtil</span>.<span class="cm-variable">isNotBlank</span>(<span
                class="cm-variable">json</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不为空，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">JSONUtil</span>.<span class="cm-variable">toBean</span>(<span
                class="cm-variable">json</span>, <span class="cm-variable">type</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">json</span> <span class="cm-operator">!=</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//空串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">R</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-variable">dbFallback</span>.<span class="cm-variable">apply</span>(<span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">r</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库也为空，缓存空值</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-string">""</span>, <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">timeUnit</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库存在，写入redis</span></span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-variable">r</span>, <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">timeUnit</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1081px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1081px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h2 id='缓存雪崩'><span>缓存雪崩</span></h2>
        <h3 id='是什么-2'><span>是什么？</span></h3>
        <p><span>缓存雪崩是指在同一时段大量的缓存 key 同时失效或者 Redis 服务宕机，导致大量请求到达数据库，给数据库带来巨大压力。</span></p>
        <h3 id='解决方案-2'><span>解决方案</span></h3><h4 id='给不同的-key-的-ttl过期时间）添加随机值'>
            <strong><span>给不同的 Key 的 TTL（过期时间）添加随机值</span></strong></h4>
        <p><span>一般在做缓存预热时，可能会提前将数据库中的数据批量导入到缓存中，由于是批量导入的，所以这些 key 的 TTL 是一样的，这就很有可能导致这些 key 在未来的某一时刻一起过期，从而引发缓存雪崩问题。为了解决这个问题，我们可以在做缓存预热时，可以在设置 TTL 时，在 TTL 后面追加一个随机数，比如 TTL 设置的 30 分钟，我们在30 的基础上加上一个 1~5之间的随机数，那么这些 key 的过期时间就会在 30 ~ 35 之间，这样就可以将 key 的过期时间分散开来，而不是一起失效。</span>
        </p><h4 id='利用-redis-集群提高服务的可用性'><strong><span>利用 Redis 集群提高服务的可用性</span></strong></h4>
        <p><span>利用 Redis 的哨兵机制，Redis 哨兵机制可以实现服务的监控，比如在一个主从模式下的 Redis 集群，当主机宕机时，哨兵就会从从机中选出一个来替代主机，这样就可以确保 Redis 一直对外提供服务。另外，主从模式还可以实现数据的同步，当主机宕机，从机上的数据也不会丢失。</span>
        </p><h4 id='给缓存业务添加降级限流策略'><strong><span>给缓存业务添加降级限流策略</span></strong></h4><h4 id='给业务添加多级缓存'><strong><span>给业务添加多级缓存</span></strong>
        </h4>
        <p><span>可以先在反向代理服务器 Nginx 中做缓存，在 Nginx 中未命中缓存时，再去 Redis 中查询</span></p>
        <p>&nbsp;</p>
        <h3 id='解决缓存雪崩'><span>解决缓存雪崩</span></h3>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span><span
                class="cm-comment">/**</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 查询数据，有缓存，解决缓存穿透问题，解决缓存雪崩问题</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param keyPrefix &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  redisKey的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param dbFallback &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 查询数据库的函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param expireTime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 时间单位</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;R&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param maxTimeSecondsByCacheAvalanche this.set(redisKey, r,</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeUnit.toSeconds(expireTime)+getIntRandom(0,maxTimeSecondsByCacheAvalanche), TimeUnit.SECONDS);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 泛型R</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">R</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">R</span> <span class="cm-def">queryWithPassThroughAndCacheAvalanche</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable">ID</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">type</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">ID</span>, <span class="cm-variable">R</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>, <span
                class="cm-variable-3">Long</span> <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">TimeUnit</span> <span class="cm-variable">timeUnit</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span
                class="cm-variable-3">Integer</span> <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>)</span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查询redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">json</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">StrUtil</span>.<span class="cm-variable">isNotBlank</span>(<span
                class="cm-variable">json</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不为空，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">JSONUtil</span>.<span class="cm-variable">toBean</span>(<span
                class="cm-variable">json</span>, <span class="cm-variable">type</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">json</span> <span class="cm-operator">!=</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//空串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">R</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-variable">dbFallback</span>.<span class="cm-variable">apply</span>(<span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">r</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库也为空，缓存空值</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-string">""</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeUnit</span>.<span class="cm-variable">toSeconds</span>(<span
                class="cm-variable">expireTime</span>) <span class="cm-operator">+</span> <span class="cm-variable">getIntRandom</span>(<span
                class="cm-number">0</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>),</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库存在，写入redis</span></span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-variable">r</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeUnit</span>.<span class="cm-variable">toSeconds</span>(<span
                class="cm-variable">expireTime</span>) <span class="cm-operator">+</span> <span class="cm-variable">getIntRandom</span>(<span
                class="cm-number">0</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>),</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> <span
                class="cm-tab" role="presentation" cm-text="	">   </span><span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 获取一个随机数，区间包含min和max</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param min 最小值</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param max 最大值</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return int 型的随机数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@SuppressWarnings</span>(<span class="cm-string">"all"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable-3">int</span> <span class="cm-def">getIntRandom</span>(<span
                class="cm-variable-3">int</span> <span class="cm-variable">min</span>, <span
                class="cm-variable-3">int</span> <span class="cm-variable">max</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">min</span> <span class="cm-operator">&gt;</span> <span
                class="cm-variable">max</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">min</span> <span class="cm-operator">=</span> <span class="cm-variable">max</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">min</span> <span class="cm-operator">+</span> (<span
                class="cm-variable-3">int</span>) (<span class="cm-variable">Math</span>.<span class="cm-variable">random</span>() <span
                class="cm-operator">*</span> (<span class="cm-variable">max</span> <span
                class="cm-operator">-</span> <span class="cm-variable">min</span> <span
                class="cm-operator">+</span> <span class="cm-number">1</span>));</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1656px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1656px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h2 id='缓存击穿'><span>缓存击穿</span></h2>
        <h3 id='是什么-3'><span>是什么？</span></h3>
        <p><span>缓存击穿问题也叫热点 key 问题，就是一个被高并发访问并且缓存重建业务较复杂的 key 突然失效了，无效的请求访问会在瞬间给数据库带来巨大压力。</span></p>
        <h3 id='解决方案-3'><span>解决方案</span></h3><h4 id='互斥锁-1'><span>互斥锁</span></h4>
        <p><span>假设线程 1 查询缓存未命中，那么线程 1 就需要进行缓存重建工作，为了避免其他线程重复线程1 的工作，那么线程 1 就必须要先获取互斥锁，只有获取锁成功的线程才能够重建缓存数据。重建完成后，线程 1 就会将数据写入到缓存中，并将锁释放。如果在线程 1 将数据写入缓存之前，其他线程涌入，这个时候，其他线程查询缓存依然是未命中的，那么这些线程为了重建缓存，也必须先获取到互斥锁，但是，由于此时线程 1 未释放锁，所以其他线程就会获取锁失败，一旦获取锁失败，一般程序处理是让线程休眠一会儿，然后再重试（包括查询缓存以及获取互斥锁），如果线程 1 执行缓存重建时间过长，就会导致其他线程一直处于阻塞等待重试的状态，效率过低。</span>
        </p><h4 id='逻辑过期-1'><span>逻辑过期</span></h4>
        <p><span>当我们在向 Redis 中存储数据时，不再为 key 设置过期时间（TTL），但是，需要在 value 中额外添加一个逻辑时间（以当前时间为基础，加上需要设置的过期时间），也就是说，这个 key 一旦存入到 Redis 中，就会永不过期。假设线程 1 在查询缓存时发现逻辑时间已经过期，为了避免出现多个线程重建缓存，线程 1 就会去获取互斥锁，一旦线程 1 获取互斥锁成功，线程 1 就会开启一个独立线程，由独立线程去查询数据库重建缓存数据，以及写入缓存重置逻辑过期时间等操作，一旦完成操作，独立线程就会将互斥锁释放掉。线程 1 在开启独立线程后，会直接将过期数据返回。而在独立线程释放锁之前，缓存中的数据都是过期数据。当其他线程在此之前涌入程序时，去查询缓存获取到依旧是逻辑时间过期的数据，那么这些线程就会试图获取互斥锁，此时由于独立线程还未释放锁，所以会获取锁失败，一旦失败，这些线程就会将查询到的旧数据返回。只有当独立线程执行结束，其他线程才会从缓存中获取到新数据。</span>
        </p>
        <p>&nbsp;</p><h4 id='两种方案的优点和缺点'><span>两种方案的优点和缺点</span></h4><h5 id='互斥锁-2'><span>互斥锁</span></h5>
        <p><span>	</span><span>优点：</span></p>
        <ul>
            <li><span>没有额外的内存消耗</span></li>
            <li><span>保证一致性</span></li>
            <li><span>实现简单</span></li>
        </ul>
        <p><span>	</span><span>缺点：</span></p>
        <ul>
            <li><span>线程需要等待，性能受影响</span></li>
            <li><span>可能有死锁风险</span></li>
        </ul>
        <h5 id='逻辑过期-2'><span>逻辑过期</span></h5>
        <p><span>	</span><span>优点：</span></p>
        <ul>
            <li><span>线程无需等待，性能较好</span></li>
        </ul>
        <p><span>	</span><span>缺点：</span></p>
        <ul>
            <li><span>不保证一致性</span></li>
            <li><span>有额外内存消耗</span></li>
            <li><span>实现复杂</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='解决缓存击穿'><span>解决缓存击穿</span></h3><h4 id='互斥锁-3'><span>互斥锁</span></h4>
        <p><span>使用 SETNX 命令来实现互斥锁</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span><span
                class="cm-meta">@Resource</span></span></pre></div><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">//线程池</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable">ExecutorService</span> <span
                class="cm-variable">CACHE_REBUILD_EXECUTOR</span> <span class="cm-operator">=</span> <span
                class="cm-variable">Executors</span>.<span class="cm-variable">newFixedThreadPool</span>(<span
                class="cm-number">10</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 向redis里添加数据</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param redisKey &nbsp; redis的key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param value &nbsp; &nbsp;  数据</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param expireTime 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; 时间单位</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">set</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span>, <span
                class="cm-variable-3">Object</span> <span class="cm-variable">value</span>, <span class="cm-variable-3">Long</span> <span
                class="cm-variable">expireTime</span>, <span class="cm-variable">TimeUnit</span> <span
                class="cm-variable">timeUnit</span>)</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">opsForValue</span>().<span
                class="cm-variable">set</span>(<span class="cm-variable">redisKey</span>, <span class="cm-variable">JSONUtil</span>.<span
                class="cm-variable">toJsonStr</span>(<span class="cm-variable">value</span>), <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">timeUnit</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/**</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param key redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 获取锁成功，返回true，否则返回false</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">boolean</span> <span class="cm-def">tryLock</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">key</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Boolean</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">setIfAbsent</span>(<span
                class="cm-variable">key</span>, <span class="cm-string">"1"</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">LOCK_SHOP_TTL</span>, <span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">BooleanUtil</span>.<span class="cm-variable">isTrue</span>(<span
                class="cm-variable">result</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param key redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">void</span> <span class="cm-def">unlock</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">key</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">key</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/**</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 查询数据，解决缓存穿透，互斥锁方法解决缓存击穿，解决缓存雪崩</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param keyPrefix &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  redisKey的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param lockKeyPrefix &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  锁的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param dbFallback &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 查询数据库的函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param expireTime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 时间单位</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;R&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param maxTimeSecondsByCacheAvalanche this.set(redisKey, r,</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeUnit.toSeconds(expireTime)+getIntRandom(0,maxTimeSecondsByCacheAvalanche), TimeUnit.SECONDS);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 泛型R</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">R</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">R</span> <span class="cm-def">query</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">keyPrefix</span>, <span class="cm-variable-3">String</span> <span
                class="cm-variable">lockKeyPrefix</span>, <span class="cm-variable">ID</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">type</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">ID</span>, <span class="cm-variable">R</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>, <span
                class="cm-variable-3">Long</span> <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">TimeUnit</span> <span class="cm-variable">timeUnit</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span
                class="cm-variable-3">Integer</span> <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>)</span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获取redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//从redis中查询信息，根据id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">json</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断取出的数据是否为空</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">StrUtil</span>.<span class="cm-variable">isNotBlank</span>(<span
                class="cm-variable">json</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不是空，redis里有，返回</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">JSONUtil</span>.<span class="cm-variable">toBean</span>(<span
                class="cm-variable">json</span>, <span class="cm-variable">type</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//是空串，不是null，返回</span></span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">json</span> <span class="cm-operator">!=</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//锁的key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">lockKeyPrefix</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">R</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取互斥锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">lock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">tryLock</span>(<span
                class="cm-variable">lockKey</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断锁是否获取成功</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span
                class="cm-variable">lock</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//没有获取到锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//200毫秒后再次获取</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Thread</span>.<span class="cm-variable">sleep</span>(<span
                class="cm-number">200</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//递归调用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">query</span>(<span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable">lockKeyPrefix</span>, <span class="cm-variable">id</span>, <span
                class="cm-variable">type</span>, <span class="cm-variable">dbFallback</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">expireTime</span>, <span class="cm-variable">timeUnit</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>);</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//得到了锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//null，查数据库</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-variable">dbFallback</span>.<span class="cm-variable">apply</span>(<span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断数据库里的信息是否为空</span></span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">r</span> <span
                class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库也为空，缓存空值</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-string">""</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeUnit</span>.<span class="cm-variable">toSeconds</span>(<span
                class="cm-variable">expireTime</span>) <span class="cm-operator">+</span> <span class="cm-variable">getIntRandom</span>(<span
                class="cm-number">0</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>),</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//存在，回写到redis里，设置随机的过期时间</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-variable">r</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeUnit</span>.<span class="cm-variable">toSeconds</span>(<span
                class="cm-variable">expireTime</span>) <span class="cm-operator">+</span> <span class="cm-variable">getIntRandom</span>(<span
                class="cm-number">0</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>),</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span
                class="cm-variable">e</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">RuntimeException</span>(<span
                class="cm-variable">e</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">finally</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">unlock</span>(<span
                class="cm-variable">lockKey</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/**</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 获取一个随机数，区间包含min和max</span></span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param min 最小值</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param max 最大值</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return int 型的随机数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@SuppressWarnings</span>(<span class="cm-string">"all"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable-3">int</span> <span class="cm-def">getIntRandom</span>(<span
                class="cm-variable-3">int</span> <span class="cm-variable">min</span>, <span
                class="cm-variable-3">int</span> <span class="cm-variable">max</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">min</span> <span class="cm-operator">&gt;</span> <span
                class="cm-variable">max</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">min</span> <span class="cm-operator">=</span> <span class="cm-variable">max</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">min</span> <span class="cm-operator">+</span> (<span
                class="cm-variable-3">int</span>) (<span class="cm-variable">Math</span>.<span class="cm-variable">random</span>() <span
                class="cm-operator">*</span> (<span class="cm-variable">max</span> <span
                class="cm-operator">-</span> <span class="cm-variable">min</span> <span
                class="cm-operator">+</span> <span class="cm-number">1</span>));</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3312px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 3312px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p><h4 id='逻辑过期-3'><span>逻辑过期</span></h4>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span> <span
                class="cm-meta">@Resource</span></span></pre></div><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">//线程池</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable">ExecutorService</span> <span
                class="cm-variable">CACHE_REBUILD_EXECUTOR</span> <span class="cm-operator">=</span> <span
                class="cm-variable">Executors</span>.<span class="cm-variable">newFixedThreadPool</span>(<span
                class="cm-number">10</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 向redis里添加数据</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param redisKey &nbsp; redis的key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param value &nbsp; &nbsp;  数据</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param expireTime 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; 时间单位</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">set</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span>, <span
                class="cm-variable-3">Object</span> <span class="cm-variable">value</span>, <span class="cm-variable-3">Long</span> <span
                class="cm-variable">expireTime</span>, <span class="cm-variable">TimeUnit</span> <span
                class="cm-variable">timeUnit</span>)</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">opsForValue</span>().<span
                class="cm-variable">set</span>(<span class="cm-variable">redisKey</span>, <span class="cm-variable">JSONUtil</span>.<span
                class="cm-variable">toJsonStr</span>(<span class="cm-variable">value</span>), <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">timeUnit</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 向redis里添加数据 设置逻辑过期</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param redisKey &nbsp; redis的key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param value &nbsp; &nbsp;  数据</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param expireTime 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; 时间单位</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">setWithLogicalExpire</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span>, <span
                class="cm-variable-3">Object</span> <span class="cm-variable">value</span>, <span class="cm-variable-3">Long</span> <span
                class="cm-variable">expireTime</span>, <span class="cm-variable">TimeUnit</span> <span
                class="cm-variable">timeUnit</span>)</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisData</span> <span class="cm-variable">redisData</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">RedisData</span>();</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//添加数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">redisData</span>.<span
                class="cm-variable">setData</span>(<span class="cm-variable">value</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置过期时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">redisData</span>.<span
                class="cm-variable">setExpireTime</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>().<span class="cm-variable">plusSeconds</span>(<span class="cm-variable">timeUnit</span>.<span
                class="cm-variable">toSeconds</span>(<span class="cm-variable">expireTime</span>)));</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//放入redis</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">set</span>(<span class="cm-variable">redisKey</span>, <span
                class="cm-variable">JSONUtil</span>.<span class="cm-variable">toJsonStr</span>(<span
                class="cm-variable">redisData</span>));</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/**</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param keyPrefix &nbsp; &nbsp; redisKey的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param lockKeyPrefix 锁的前缀</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param type &nbsp; &nbsp; &nbsp; &nbsp;  返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param dbFallback &nbsp;  查询数据库的函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param time &nbsp; &nbsp; &nbsp; &nbsp;  过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; &nbsp;  时间单位</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;R&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; &nbsp;  id的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 泛型R</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">R</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">R</span> <span class="cm-def">queryWithLogicalExpire</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKeyPrefix</span>, <span
                class="cm-variable">ID</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">type</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">ID</span>, <span class="cm-variable">R</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>, <span
                class="cm-variable-3">Long</span> <span class="cm-variable">time</span>, <span class="cm-variable">TimeUnit</span> <span
                class="cm-variable">timeUnit</span>)</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得前缀</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查询redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">json</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">StrUtil</span>.<span class="cm-variable">isBlank</span>(<span class="cm-variable">json</span>))</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//空，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//json 反序列化为对象</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisData</span> <span class="cm-variable">redisData</span> <span
                class="cm-operator">=</span> <span class="cm-variable">JSONUtil</span>.<span
                class="cm-variable">toBean</span>(<span class="cm-variable">json</span>, <span class="cm-variable">RedisData</span>.<span
                class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">LocalDateTime</span> <span class="cm-variable">expireTime</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisData</span>.<span class="cm-variable">getExpireTime</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">R</span> <span
                class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-variable">JSONUtil</span>.<span class="cm-variable">toBean</span>((<span class="cm-variable">JSONObject</span>) <span
                class="cm-variable">redisData</span>.<span class="cm-variable">getData</span>(), <span
                class="cm-variable">type</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断是否过期</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">expireTime</span>.<span class="cm-variable">isAfter</span>(<span
                class="cm-variable">LocalDateTime</span>.<span class="cm-variable">now</span>()))</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//未过期，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">r</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//过期，缓存重建</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获取互斥锁</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">lockKeyPrefix</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">isLock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">tryLock</span>(<span
                class="cm-variable">lockKey</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">isLock</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取锁成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 开辟独立线程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">CACHE_REBUILD_EXECUTOR</span>.<span class="cm-variable">submit</span>(<span
                class="cm-keyword">new</span> <span class="cm-variable">Runnable</span>()</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span
                class="cm-variable">run</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">R</span> <span class="cm-variable">r1</span> <span
                class="cm-operator">=</span> <span class="cm-variable">dbFallback</span>.<span
                class="cm-variable">apply</span>(<span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">setWithLogicalExpire</span>(<span class="cm-variable">redisKey</span>, <span
                class="cm-variable">r1</span>, <span class="cm-variable">time</span>, <span
                class="cm-variable">timeUnit</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span
                class="cm-variable">e</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">RuntimeException</span>(<span
                class="cm-variable">e</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">finally</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">unlock</span>(<span class="cm-variable">lockKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  });</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//没有获取到锁，使用旧数据返回</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param key redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 获取锁成功，返回true，否则返回false</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">boolean</span> <span class="cm-def">tryLock</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">key</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Boolean</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">setIfAbsent</span>(<span
                class="cm-variable">key</span>, <span class="cm-string">"1"</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">LOCK_SHOP_TTL</span>, <span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">BooleanUtil</span>.<span class="cm-variable">isTrue</span>(<span
                class="cm-variable">result</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param key redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">void</span> <span class="cm-def">unlock</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">key</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">key</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 获取一个随机数，区间包含min和max</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param min 最小值</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param max 最大值</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return int 型的随机数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@SuppressWarnings</span>(<span class="cm-string">"all"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable-3">int</span> <span class="cm-def">getIntRandom</span>(<span
                class="cm-variable-3">int</span> <span class="cm-variable">min</span>, <span
                class="cm-variable-3">int</span> <span class="cm-variable">max</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">min</span> <span class="cm-operator">&gt;</span> <span
                class="cm-variable">max</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">min</span> <span class="cm-operator">=</span> <span class="cm-variable">max</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">min</span> <span class="cm-operator">+</span> (<span
                class="cm-variable-3">int</span>) (<span class="cm-variable">Math</span>.<span class="cm-variable">random</span>() <span
                class="cm-operator">*</span> (<span class="cm-variable">max</span> <span
                class="cm-operator">-</span> <span class="cm-variable">min</span> <span
                class="cm-operator">+</span> <span class="cm-number">1</span>));</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3519px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 3519px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>redisData:</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div
                class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@Data</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@AllArgsConstructor</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@NoArgsConstructor</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span
                class="cm-def">RedisData</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">LocalDateTime</span> <span class="cm-variable">expireTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">data</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 184px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h1 id='redis工具类'><span>redis工具类</span></h1>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>;</span></pre></div><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">BooleanUtil</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">StrUtil</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">json</span>.<span class="cm-variable">JSONObject</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">json</span>.<span class="cm-variable">JSONUtil</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">lombok</span>.<span class="cm-variable">extern</span>.<span
                class="cm-variable">slf4j</span>.<span class="cm-variable">Slf4j</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">RedisData</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Component</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">LocalDateTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">ExecutorService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">Executors</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">TimeUnit</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">function</span>.<span class="cm-variable">Function</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Project name(项目名称)：spring_boot_redis_hmdp_redis_utils</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Package(包名): mao.spring_boot_redis_hmdp.utils</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Class(类名): RedisUtils</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author(作者）: mao</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author QQ：1296193245</span></span></pre><pre class=" CodeMirror-line "
                                                                                  role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* GitHub：https://github.com/maomao124/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Date(创建日期)： 2022/5/14</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Time(创建时间)： 20:48</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Version(版本): 1.0</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Description(描述)： redis工具类</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">*/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Slf4j</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Component</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span
                class="cm-def">RedisUtils</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">//线程池</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable">ExecutorService</span> <span
                class="cm-variable">CACHE_REBUILD_EXECUTOR</span> <span class="cm-operator">=</span> <span
                class="cm-variable">Executors</span>.<span class="cm-variable">newFixedThreadPool</span>(<span
                class="cm-number">10</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 向redis里添加数据</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param redisKey &nbsp; redis的key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param value &nbsp; &nbsp;  数据</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param expireTime 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; 时间单位</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span
                class="cm-variable">set</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span>, <span
                class="cm-variable-3">Object</span> <span class="cm-variable">value</span>, <span class="cm-variable-3">Long</span> <span
                class="cm-variable">expireTime</span>, <span class="cm-variable">TimeUnit</span> <span
                class="cm-variable">timeUnit</span>)</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">opsForValue</span>().<span
                class="cm-variable">set</span>(<span class="cm-variable">redisKey</span>, <span class="cm-variable">JSONUtil</span>.<span
                class="cm-variable">toJsonStr</span>(<span class="cm-variable">value</span>), <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">timeUnit</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 向redis里添加数据 设置逻辑过期</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param redisKey &nbsp; redis的key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param value &nbsp; &nbsp;  数据</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param expireTime 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; 时间单位</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">setWithLogicalExpire</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span>, <span
                class="cm-variable-3">Object</span> <span class="cm-variable">value</span>, <span class="cm-variable-3">Long</span> <span
                class="cm-variable">expireTime</span>, <span class="cm-variable">TimeUnit</span> <span
                class="cm-variable">timeUnit</span>)</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisData</span> <span class="cm-variable">redisData</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">RedisData</span>();</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//添加数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">redisData</span>.<span
                class="cm-variable">setData</span>(<span class="cm-variable">value</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置过期时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">redisData</span>.<span
                class="cm-variable">setExpireTime</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>().<span class="cm-variable">plusSeconds</span>(<span class="cm-variable">timeUnit</span>.<span
                class="cm-variable">toSeconds</span>(<span class="cm-variable">expireTime</span>)));</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//放入redis</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">set</span>(<span class="cm-variable">redisKey</span>, <span
                class="cm-variable">JSONUtil</span>.<span class="cm-variable">toJsonStr</span>(<span
                class="cm-variable">redisData</span>));</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 查询数据，有缓存，解决缓存穿透问题，未解决缓存雪崩问题</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param keyPrefix  redisKey的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param type &nbsp; &nbsp; &nbsp; 返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param dbFallback 查询数据库的函数</span></span></pre><pre class=" CodeMirror-line "
                                                                                        role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param expireTime 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; 时间单位</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param &lt;R&gt; &nbsp; &nbsp; &nbsp;  返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; id的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 泛型R</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">R</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">R</span> <span class="cm-variable">queryWithPassThrough</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable">ID</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">type</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">ID</span>, <span class="cm-variable">R</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>, <span
                class="cm-variable-3">Long</span> <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">TimeUnit</span> <span class="cm-variable">timeUnit</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得前缀</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查询redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">json</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">StrUtil</span>.<span class="cm-variable">isNotBlank</span>(<span
                class="cm-variable">json</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不为空，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">JSONUtil</span>.<span class="cm-variable">toBean</span>(<span
                class="cm-variable">json</span>, <span class="cm-variable">type</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">json</span> <span class="cm-operator">!=</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//空串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">R</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-variable">dbFallback</span>.<span class="cm-variable">apply</span>(<span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">r</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库也为空，缓存空值</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-string">""</span>, <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">timeUnit</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库存在，写入redis</span></span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-variable">r</span>, <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">timeUnit</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 查询数据，有缓存，解决缓存穿透问题，解决缓存雪崩问题</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param keyPrefix &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  redisKey的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param dbFallback &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 查询数据库的函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param expireTime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 时间单位</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;R&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param maxTimeSecondsByCacheAvalanche this.set(redisKey, r,</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeUnit.toSeconds(expireTime)+getIntRandom(0,maxTimeSecondsByCacheAvalanche), TimeUnit.SECONDS);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 泛型R</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">R</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">R</span> <span
                class="cm-variable">queryWithPassThroughAndCacheAvalanche</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable">ID</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">type</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">ID</span>, <span class="cm-variable">R</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>, <span
                class="cm-variable-3">Long</span> <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">TimeUnit</span> <span class="cm-variable">timeUnit</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span
                class="cm-variable-3">Integer</span> <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>)</span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查询redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">json</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">StrUtil</span>.<span class="cm-variable">isNotBlank</span>(<span
                class="cm-variable">json</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不为空，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">JSONUtil</span>.<span class="cm-variable">toBean</span>(<span
                class="cm-variable">json</span>, <span class="cm-variable">type</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">json</span> <span class="cm-operator">!=</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//空串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">R</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-variable">dbFallback</span>.<span class="cm-variable">apply</span>(<span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">r</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库也为空，缓存空值</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-string">""</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeUnit</span>.<span class="cm-variable">toSeconds</span>(<span
                class="cm-variable">expireTime</span>) <span class="cm-operator">+</span> <span class="cm-variable">getIntRandom</span>(<span
                class="cm-number">0</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>),</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库存在，写入redis</span></span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-variable">r</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeUnit</span>.<span class="cm-variable">toSeconds</span>(<span
                class="cm-variable">expireTime</span>) <span class="cm-operator">+</span> <span class="cm-variable">getIntRandom</span>(<span
                class="cm-number">0</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>),</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 查询数据，解决缓存穿透，互斥锁方法解决缓存击穿，解决缓存雪崩</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param keyPrefix &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  redisKey的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param lockKeyPrefix &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  锁的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param dbFallback &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 查询数据库的函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param expireTime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 时间单位</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;R&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param maxTimeSecondsByCacheAvalanche this.set(redisKey, r,</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeUnit.toSeconds(expireTime)+getIntRandom(0,maxTimeSecondsByCacheAvalanche), TimeUnit.SECONDS);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 泛型R</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">R</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">R</span> <span class="cm-variable">query</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKeyPrefix</span>, <span
                class="cm-variable">ID</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">type</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">ID</span>, <span class="cm-variable">R</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>, <span
                class="cm-variable-3">Long</span> <span class="cm-variable">expireTime</span>, <span
                class="cm-variable">TimeUnit</span> <span class="cm-variable">timeUnit</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span
                class="cm-variable-3">Integer</span> <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>)</span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获取redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//从redis中查询信息，根据id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">json</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断取出的数据是否为空</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">StrUtil</span>.<span class="cm-variable">isNotBlank</span>(<span
                class="cm-variable">json</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不是空，redis里有，返回</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">JSONUtil</span>.<span class="cm-variable">toBean</span>(<span
                class="cm-variable">json</span>, <span class="cm-variable">type</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//是空串，不是null，返回</span></span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">json</span> <span class="cm-operator">!=</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//锁的key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">lockKeyPrefix</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">R</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取互斥锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">lock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">tryLock</span>(<span
                class="cm-variable">lockKey</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断锁是否获取成功</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span
                class="cm-variable">lock</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//没有获取到锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//200毫秒后再次获取</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Thread</span>.<span class="cm-variable">sleep</span>(<span
                class="cm-number">200</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//递归调用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">query</span>(<span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable">lockKeyPrefix</span>, <span class="cm-variable">id</span>, <span
                class="cm-variable">type</span>, <span class="cm-variable">dbFallback</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">expireTime</span>, <span class="cm-variable">timeUnit</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>);</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//得到了锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//null，查数据库</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-variable">dbFallback</span>.<span class="cm-variable">apply</span>(<span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断数据库里的信息是否为空</span></span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">r</span> <span
                class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库也为空，缓存空值</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-string">""</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeUnit</span>.<span class="cm-variable">toSeconds</span>(<span
                class="cm-variable">expireTime</span>) <span class="cm-operator">+</span> <span class="cm-variable">getIntRandom</span>(<span
                class="cm-number">0</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>),</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//存在，回写到redis里，设置随机的过期时间</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">set</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-variable">r</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeUnit</span>.<span class="cm-variable">toSeconds</span>(<span
                class="cm-variable">expireTime</span>) <span class="cm-operator">+</span> <span class="cm-variable">getIntRandom</span>(<span
                class="cm-number">0</span>, <span
                class="cm-variable">maxTimeSecondsByCacheAvalanche</span>),</span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span
                class="cm-variable">e</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">RuntimeException</span>(<span
                class="cm-variable">e</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">finally</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">unlock</span>(<span
                class="cm-variable">lockKey</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 更新数据</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; 要更新的主键</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param data &nbsp; &nbsp; &nbsp; 要更新的对象</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param keyPrefix  redis的key前缀</span></span></pre><pre class=" CodeMirror-line "
                                                                                           role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param dbFallback 更新数据库的函数，返回值要为Boolean类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;T&gt; &nbsp; &nbsp; &nbsp;  要更新的对象的泛型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; 主键的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return boolean</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">T</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span>(<span class="cm-variable">ID</span> <span
                class="cm-variable">id</span>, <span class="cm-variable">T</span> <span class="cm-variable">data</span>, <span
                class="cm-variable-3">String</span> <span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">T</span>, <span class="cm-variable-3">Boolean</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">id</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//先更新数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">b</span> <span
                class="cm-operator">=</span> <span class="cm-variable">dbFallback</span>.<span
                class="cm-variable">apply</span>(<span class="cm-variable">data</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//更新失败，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-operator">!</span><span class="cm-variable">b</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//更新没有失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//删除redis里的数据，下一次查询时自动添加进redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//redisKey</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">delete</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回响应</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param keyPrefix &nbsp; &nbsp; redisKey的前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param lockKeyPrefix 锁的前缀</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param type &nbsp; &nbsp; &nbsp; &nbsp;  返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param dbFallback &nbsp;  查询数据库的函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param time &nbsp; &nbsp; &nbsp; &nbsp;  过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param timeUnit &nbsp; &nbsp;  时间单位</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;R&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param &lt;ID&gt; &nbsp; &nbsp; &nbsp; &nbsp;  id的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 泛型R</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">R</span>, <span
                class="cm-variable">ID</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">R</span> <span class="cm-variable">queryWithLogicalExpire</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">keyPrefix</span>, <span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKeyPrefix</span>, <span
                class="cm-variable">ID</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">type</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Function</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">ID</span>, <span class="cm-variable">R</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dbFallback</span>, <span
                class="cm-variable-3">Long</span> <span class="cm-variable">time</span>, <span class="cm-variable">TimeUnit</span> <span
                class="cm-variable">timeUnit</span>)</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得前缀</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">keyPrefix</span> <span class="cm-operator">+</span> <span
                class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//查询redis</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">json</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">StrUtil</span>.<span class="cm-variable">isBlank</span>(<span class="cm-variable">json</span>))</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//空，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不为空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//json 反序列化为对象</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisData</span> <span class="cm-variable">redisData</span> <span
                class="cm-operator">=</span> <span class="cm-variable">JSONUtil</span>.<span
                class="cm-variable">toBean</span>(<span class="cm-variable">json</span>, <span class="cm-variable">RedisData</span>.<span
                class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得过期时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">LocalDateTime</span> <span class="cm-variable">expireTime</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisData</span>.<span class="cm-variable">getExpireTime</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">R</span> <span
                class="cm-variable">r</span> <span class="cm-operator">=</span> <span
                class="cm-variable">JSONUtil</span>.<span class="cm-variable">toBean</span>((<span class="cm-variable">JSONObject</span>) <span
                class="cm-variable">redisData</span>.<span class="cm-variable">getData</span>(), <span
                class="cm-variable">type</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断是否过期</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">expireTime</span>.<span class="cm-variable">isAfter</span>(<span
                class="cm-variable">LocalDateTime</span>.<span class="cm-variable">now</span>()))</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//未过期，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">r</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//过期，缓存重建</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获取互斥锁</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">lockKeyPrefix</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">isLock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">tryLock</span>(<span
                class="cm-variable">lockKey</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">isLock</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取锁成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 开辟独立线程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">CACHE_REBUILD_EXECUTOR</span>.<span class="cm-variable">submit</span>(<span
                class="cm-keyword">new</span> <span class="cm-variable">Runnable</span>()</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span
                class="cm-variable">run</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">R</span> <span class="cm-variable">r1</span> <span
                class="cm-operator">=</span> <span class="cm-variable">dbFallback</span>.<span
                class="cm-variable">apply</span>(<span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">setWithLogicalExpire</span>(<span class="cm-variable">redisKey</span>, <span
                class="cm-variable">r1</span>, <span class="cm-variable">time</span>, <span
                class="cm-variable">timeUnit</span>);</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span
                class="cm-variable">e</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">RuntimeException</span>(<span
                class="cm-variable">e</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">finally</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">unlock</span>(<span class="cm-variable">lockKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  });</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//没有获取到锁，使用旧数据返回</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param key redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 获取锁成功，返回true，否则返回false</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">boolean</span> <span class="cm-variable">tryLock</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">key</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Boolean</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">setIfAbsent</span>(<span
                class="cm-variable">key</span>, <span class="cm-string">"1"</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">LOCK_SHOP_TTL</span>, <span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">BooleanUtil</span>.<span class="cm-variable">isTrue</span>(<span
                class="cm-variable">result</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param key redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">void</span> <span class="cm-variable">unlock</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">key</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">delete</span>(<span class="cm-variable">key</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 获取一个随机数，区间包含min和max</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param min 最小值</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param max 最大值</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return int 型的随机数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@SuppressWarnings</span>(<span class="cm-string">"all"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable-3">int</span> <span class="cm-variable">getIntRandom</span>(<span
                class="cm-variable-3">int</span> <span class="cm-variable">min</span>, <span
                class="cm-variable-3">int</span> <span class="cm-variable">max</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">min</span> <span class="cm-operator">&gt;</span> <span
                class="cm-variable">max</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">min</span> <span class="cm-operator">=</span> <span class="cm-variable">max</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">min</span> <span class="cm-operator">+</span> (<span
                class="cm-variable-3">int</span>) (<span class="cm-variable">Math</span>.<span class="cm-variable">random</span>() <span
                class="cm-operator">*</span> (<span class="cm-variable">max</span> <span
                class="cm-operator">-</span> <span class="cm-variable">min</span> <span
                class="cm-operator">+</span> <span class="cm-number">1</span>));</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 9522px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 9522px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>redisData:</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div
                class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@Data</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@AllArgsConstructor</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@NoArgsConstructor</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span
                class="cm-def">RedisData</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">LocalDateTime</span> <span class="cm-variable">expireTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">data</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 184px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h1 id='优惠券秒杀'><span>优惠券秒杀</span></h1>
        <h2 id='全局唯一id'><span>全局唯一ID</span></h2>
        <ul>
            <li><span>唯一性</span></li>
            <li><span>高可用</span></li>
            <li><span>高性能</span></li>
            <li><span>递增型</span></li>
            <li><span>安全性</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='组成'><span>组成：</span></h3>
        <ul>
            <li><span>符号位：1 bit，永远为 0</span></li>
            <li><span>时间戳：31 bit，以秒为单位，可以使用 69 年</span></li>
            <li><span>序列号：32 bit，秒内的计数器，支持每秒产生 2^32 个不同的 ID</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='实现-1'><span>实现</span></h3>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>;</span></pre></div><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Component</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">LocalDateTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">ZoneOffset</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">format</span>.<span class="cm-variable">DateTimeFormatter</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Project name(项目名称)：spring_boot_redis_hmdp_global_id_generator</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Package(包名): mao.spring_boot_redis_hmdp.utils</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Class(类名): RedisIDGenerator</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author(作者）: mao</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author QQ：1296193245</span></span></pre><pre class=" CodeMirror-line "
                                                                                  role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* GitHub：https://github.com/maomao124/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Date(创建日期)： 2022/5/15</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Time(创建时间)： 12:24</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Version(版本): 1.0</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Description(描述)： id生成器</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">*/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Component</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span
                class="cm-keyword">class</span> <span class="cm-def">RedisIDGenerator</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 2022年1月1日的时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span
                class="cm-variable-3">long</span> <span class="cm-variable">BEGIN_TIMESTAMP</span> <span
                class="cm-operator">=</span> <span class="cm-number">1640995200L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 序列号位数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">COUNT_BITS</span> <span
                class="cm-operator">=</span> <span class="cm-number">32</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 获取一个id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param prefix 前缀</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return id</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">Long</span> <span class="cm-variable">nextID</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">prefix</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取当前时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">LocalDateTime</span> <span
                class="cm-variable">now</span> <span class="cm-operator">=</span> <span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//转换成秒数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">long</span> <span class="cm-variable">nowSecond</span> <span
                class="cm-operator">=</span> <span class="cm-variable">now</span>.<span class="cm-variable">toEpochSecond</span>(<span
                class="cm-variable">ZoneOffset</span>.<span class="cm-variable">UTC</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得时间差</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">long</span> <span class="cm-variable">time</span> <span
                class="cm-operator">=</span> <span class="cm-variable">nowSecond</span> <span
                class="cm-operator">-</span> <span class="cm-variable">BEGIN_TIMESTAMP</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//格式化成字符串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">format</span> <span
                class="cm-operator">=</span> <span class="cm-variable">now</span>.<span
                class="cm-variable">format</span>(<span class="cm-variable">DateTimeFormatter</span>.<span
                class="cm-variable">ofPattern</span>(<span class="cm-string">"yyyy:MM:dd"</span>));</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//将key下存储为字符串值的整数值加一</span></span></pre><pre class=" CodeMirror-line "
                                                                                role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">count</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">increment</span>(<span
                class="cm-string">"id:"</span> <span class="cm-operator">+</span> <span
                class="cm-variable">prefix</span> <span class="cm-operator">+</span> <span class="cm-string">":"</span> <span
                class="cm-operator">+</span> <span class="cm-variable">format</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">time</span> <span class="cm-operator">&lt;&lt;</span> <span
                class="cm-variable">COUNT_BITS</span> <span class="cm-operator">|</span> <span
                class="cm-variable">count</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1426px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1426px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <h2 id='实现优惠券秒杀下单'><span>实现优惠券秒杀下单</span></h2>
        <h3 id='实现-2'><span>实现</span></h3>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">conditions</span>.<span class="cm-variable">update</span>.<span
                class="cm-variable">UpdateWrapper</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">SeckillVoucher</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">VoucherOrder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">VoucherOrderMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">ISeckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IVoucherOrderService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisIDGenerator</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">transaction</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Transactional</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">LocalDateTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span
                class="cm-keyword">class</span> <span class="cm-def">VoucherOrderServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">VoucherOrderMapper</span>, <span class="cm-variable">VoucherOrder</span><span
                class="cm-operator">&gt;</span> <span class="cm-keyword">implements</span> <span class="cm-variable">IVoucherOrderService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">ISeckillVoucherService</span> <span class="cm-variable">seckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisIDGenerator</span> <span
                class="cm-variable">redisIDGenerator</span>;</span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">seckillVoucher</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询优惠券</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SeckillVoucher</span> <span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">getById</span>(<span class="cm-variable">voucherId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"活动不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getBeginTime</span>().<span
                class="cm-variable">isAfter</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//未开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动未开始"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getEndTime</span>().<span
                class="cm-variable">isBefore</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动已经结束"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断库存是否充足</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getStock</span>() <span
                class="cm-operator">&lt;=</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//库存不足</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存不足"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-keyword">this</span>.<span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 创建订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param voucherId voucherId</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Transactional</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断当前优惠券用户是否已经下过单</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得用户id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userID</span> <span
                class="cm-operator">=</span> <span class="cm-number">5L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//todo:记得更改回来</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">synchronized</span> (<span class="cm-variable">userID</span>.<span
                class="cm-variable">toString</span>().<span class="cm-variable">intern</span>())</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">count</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">query</span>().<span
                class="cm-variable">eq</span>(<span class="cm-string">"user_id"</span>, <span
                class="cm-variable">userID</span>).<span class="cm-variable">eq</span>(<span class="cm-string">"voucher_id"</span>, <span
                class="cm-variable">voucherId</span>).<span class="cm-variable">count</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断长度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">count</span> <span
                class="cm-operator">&gt;</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//长度大于0，用户购买过</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"不能重复下单"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减库存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;</span><span class="cm-variable">SeckillVoucher</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">updateWrapper</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">updateWrapper</span>.<span class="cm-variable">setSql</span>(<span
                class="cm-string">"stock = stock - 1"</span>).<span class="cm-variable">eq</span>(<span
                class="cm-string">"voucher_id"</span>, <span class="cm-variable">voucherId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">update</span>(<span class="cm-variable">updateWrapper</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存扣减失败"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">VoucherOrder</span>();</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">orderID</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisIDGenerator</span>.<span
                class="cm-variable">nextID</span>(<span class="cm-string">"order"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setVoucherId</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setId</span>(<span
                class="cm-variable">orderID</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setUserId</span>(<span
                class="cm-variable">userID</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">save</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">orderID</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2576px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 2576px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h3 id='超卖问题'><span>超卖问题</span></h3><h4 id='原因'><span>原因</span></h4>
        <p><span>在高并发情况下，假设线程 1 查询库存，查询结果为 1 ，当线程 1 准备要去扣减库存时，其他线程也去查询库存，结果查询出来的库存数也是 1，那么这时所有的线程查询到的库存数都是大于 0 的，所有的线程都会去执行扣减操作，就会导致超卖问题。</span>
        </p><h4 id='常见解决方案'><span>常见解决方案</span></h4><h5 id='悲观锁'><span>悲观锁</span></h5>
        <ul>
            <li><span>认为线程安全问题一定会发生，因此在操作数据之前先获取锁，确保线程串行执行</span></li>
            <li><span>例如Synchronized、Lock都属于 悲观锁</span></li>
        </ul>
        <h5 id='乐观锁'><span>乐观锁</span></h5>
        <ul>
            <li><span>认为线程安全问题不一定会发生，因 此不加锁，只是在更新数据时去判断 有没有其它线程对数据做了修改。</span></li>
            <li><span>如果没有修改则认为是安全的，自 己才更新数据。</span></li>
            <li><span>如果已经被其它线程修改说明发生 了安全问题，此时可以重试或异常。</span></li>
        </ul>
        <p>&nbsp;</p><h5 id='乐观锁实现'><span>乐观锁实现</span></h5>
        <ul>
            <li><span>版本号法：给查询得到的数据加一个版本号，在多线程并发的时候，基于版本号来判断数据有没有被修改过，每当数据被修改，版本号就会加1。</span></li>
            <li><span>CAS（Compare And Swap）法：即比较和替换法，是在版本号法的基础上改进而来。CAS 法去除了版本号法中的版本号信息，以库存信息本身有没有变化为判断依据，当线程修改库存时，判断当前数据库中的库存与之前查询得到的库存数据是否一致，如果一致，则说明线程安全，可以执行扣减操作，如果不一致，则说明线程不安全，扣减失败。</span>
            </li>
        </ul>
        <p>&nbsp;</p><h5 id='优点和缺点'><span>优点和缺点</span></h5>
        <p><span>	</span><span>乐观锁：</span></p>
        <ul>
            <li><span>优点：性能好</span></li>
            <li><span>缺点：存在成功率低的问题。</span></li>
        </ul>
        <p><span>	</span><span>悲观锁：</span></p>
        <ul>
            <li><span>优点：简单粗暴</span></li>
            <li><span>缺点：性能一般</span></li>
        </ul>
        <p>&nbsp;</p><h5 id='代码改进'><span>代码改进</span></h5>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">conditions</span>.<span class="cm-variable">update</span>.<span
                class="cm-variable">UpdateWrapper</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">SeckillVoucher</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">VoucherOrder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">VoucherOrderMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">ISeckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IVoucherOrderService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisIDGenerator</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">transaction</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Transactional</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">LocalDateTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span
                class="cm-keyword">class</span> <span class="cm-def">VoucherOrderServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">VoucherOrderMapper</span>, <span class="cm-variable">VoucherOrder</span><span
                class="cm-operator">&gt;</span> <span class="cm-keyword">implements</span> <span class="cm-variable">IVoucherOrderService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">ISeckillVoucherService</span> <span class="cm-variable">seckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisIDGenerator</span> <span
                class="cm-variable">redisIDGenerator</span>;</span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">seckillVoucher</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询优惠券</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SeckillVoucher</span> <span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">getById</span>(<span class="cm-variable">voucherId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"活动不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getBeginTime</span>().<span
                class="cm-variable">isAfter</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//未开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动未开始"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getEndTime</span>().<span
                class="cm-variable">isBefore</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动已经结束"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断库存是否充足</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getStock</span>() <span
                class="cm-operator">&lt;=</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//库存不足</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存不足"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-keyword">this</span>.<span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 创建订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param voucherId voucherId</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Transactional</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断当前优惠券用户是否已经下过单</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得用户id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userID</span> <span
                class="cm-operator">=</span> <span class="cm-number">5L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//todo:记得更改回来</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">synchronized</span> (<span class="cm-variable">userID</span>.<span
                class="cm-variable">toString</span>().<span class="cm-variable">intern</span>())</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">count</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">query</span>().<span
                class="cm-variable">eq</span>(<span class="cm-string">"user_id"</span>, <span
                class="cm-variable">userID</span>).<span class="cm-variable">eq</span>(<span class="cm-string">"voucher_id"</span>, <span
                class="cm-variable">voucherId</span>).<span class="cm-variable">count</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断长度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">count</span> <span
                class="cm-operator">&gt;</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//长度大于0，用户购买过</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"不能重复下单"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减库存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;</span><span class="cm-variable">SeckillVoucher</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">updateWrapper</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">updateWrapper</span>.<span class="cm-variable">setSql</span>(<span
                class="cm-string">"stock = stock - 1"</span>).<span class="cm-variable">eq</span>(<span
                class="cm-string">"voucher_id"</span>, <span class="cm-variable">voucherId</span>).<span
                class="cm-variable">gt</span>(<span class="cm-string">"stock"</span>, <span class="cm-number">0</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">update</span>(<span class="cm-variable">updateWrapper</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存扣减失败"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">VoucherOrder</span>();</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">orderID</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisIDGenerator</span>.<span
                class="cm-variable">nextID</span>(<span class="cm-string">"order"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setVoucherId</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setId</span>(<span
                class="cm-variable">orderID</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setUserId</span>(<span
                class="cm-variable">userID</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">save</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">orderID</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2576px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 2576px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <h2 id='实现一人一单功能'><span>实现一人一单功能</span></h2>
        <p><span>要求同一个优惠券，一个用户只能下一单</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">conditions</span>.<span class="cm-variable">update</span>.<span
                class="cm-variable">UpdateWrapper</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">SeckillVoucher</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">VoucherOrder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">VoucherOrderMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">ISeckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IVoucherOrderService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisIDGenerator</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">transaction</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Transactional</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">LocalDateTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span
                class="cm-keyword">class</span> <span class="cm-def">VoucherOrderServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">VoucherOrderMapper</span>, <span class="cm-variable">VoucherOrder</span><span
                class="cm-operator">&gt;</span> <span class="cm-keyword">implements</span> <span class="cm-variable">IVoucherOrderService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">ISeckillVoucherService</span> <span class="cm-variable">seckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisIDGenerator</span> <span
                class="cm-variable">redisIDGenerator</span>;</span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">seckillVoucher</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询优惠券</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SeckillVoucher</span> <span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">getById</span>(<span class="cm-variable">voucherId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"活动不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getBeginTime</span>().<span
                class="cm-variable">isAfter</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//未开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动未开始"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getEndTime</span>().<span
                class="cm-variable">isBefore</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动已经结束"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断库存是否充足</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getStock</span>() <span
                class="cm-operator">&lt;=</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//库存不足</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存不足"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-keyword">this</span>.<span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 创建订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param voucherId voucherId</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Transactional</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断当前优惠券用户是否已经下过单</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得用户id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userID</span> <span
                class="cm-operator">=</span> <span class="cm-number">5L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//todo:记得更改回来</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">synchronized</span> (<span class="cm-variable">userID</span>.<span
                class="cm-variable">toString</span>().<span class="cm-variable">intern</span>())</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">count</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">query</span>().<span
                class="cm-variable">eq</span>(<span class="cm-string">"user_id"</span>, <span
                class="cm-variable">userID</span>).<span class="cm-variable">eq</span>(<span class="cm-string">"voucher_id"</span>, <span
                class="cm-variable">voucherId</span>).<span class="cm-variable">count</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断长度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">count</span> <span
                class="cm-operator">&gt;</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//长度大于0，用户购买过</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"不能重复下单"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减库存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;</span><span class="cm-variable">SeckillVoucher</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">updateWrapper</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">updateWrapper</span>.<span class="cm-variable">setSql</span>(<span
                class="cm-string">"stock = stock - 1"</span>).<span class="cm-variable">eq</span>(<span
                class="cm-string">"voucher_id"</span>, <span class="cm-variable">voucherId</span>).<span
                class="cm-variable">gt</span>(<span class="cm-string">"stock"</span>, <span class="cm-number">0</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">update</span>(<span class="cm-variable">updateWrapper</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存扣减失败"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">VoucherOrder</span>();</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">orderID</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisIDGenerator</span>.<span
                class="cm-variable">nextID</span>(<span class="cm-string">"order"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setVoucherId</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setId</span>(<span
                class="cm-variable">orderID</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setUserId</span>(<span
                class="cm-variable">userID</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">save</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">orderID</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2576px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 2576px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h2 id='分布式锁'><span>分布式锁</span></h2>
        <h3 id='是什么-4'><span>是什么？</span></h3>
        <p><span>满足分布式系统或集群模式下多进程可见并且互斥的锁。</span></p>
        <h3 id='特点'><span>特点</span></h3>
        <ul>
            <li><span>多进程可见</span></li>
            <li><span>互斥：必须确保只能有一个线程拿到互斥锁。</span></li>
            <li><span>高可用：必须保证大多数情况下获取锁都是成功的</span></li>
            <li><span>高性能：加锁以后就会影响业务的性能，加锁后，业务的执行变成串行执行，如果获取锁的动作又很慢，就会导致执行效率更低，雪上加霜。</span></li>
            <li><span>安全性：在获取锁的时候应当考虑一些异常情况，比如获取后还未释放，服务器宕机，锁需要怎么处理，又或者会不会产生死锁问题。</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='分布式锁的实现方式'><span>分布式锁的实现方式</span></h3>
        <ul>
            <li><span>MySQL：利用mysql本身的互斥锁机制，断开连接，自动释放锁</span></li>
            <li><span>Redis：利用setnx这样的互斥命令，利用锁超时时间，到期释放</span></li>
            <li><span>Zookeeper：利用节点的唯一性和有序性实现互斥，临时节点，断开连接自动释放</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='基于redis的分布式锁'><span>基于Redis的分布式锁</span></h3>
        <p><span>获取锁：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div
                class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline"
                                                                 style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-variable">SETNX</span> <span class="cm-variable">lock</span> <span
                class="cm-variable">thread1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">EXPIRE</span> <span
                class="cm-variable">lock</span> <span
                class="cm-number">10</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre>
        <p><span>释放锁：</span></p>
        <p><span>DEL key</span></p>
        <p>&nbsp;</p><h4 id='实现-3'><span>实现</span></h4>
        <p><span>基本锁：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span><span
                class="cm-comment">/**</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param key redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return 获取锁成功，返回true，否则返回false</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">boolean</span> <span class="cm-def">tryLock</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">key</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Boolean</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">setIfAbsent</span>(<span
                class="cm-variable">key</span>, <span class="cm-string">"1"</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">LOCK_SHOP_TTL</span>, <span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">BooleanUtil</span>.<span class="cm-variable">isTrue</span>(<span
                class="cm-variable">result</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param key redisKey</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">void</span> <span class="cm-def">unlock</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">key</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">key</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 506px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 506px;"></div></div></div></pre>
        <p><span>改进：</span></p>
        <p><span>锁接口：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>;</span></pre></div><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Project name(项目名称)：spring_boot_redis_hmdp_distributed_lock_realize_the_function_of_one_person_and_one_order</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Package(包名): mao.spring_boot_redis_hmdp.utils</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Interface(接口名): RedisLock</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author(作者）: mao</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author QQ：1296193245</span></span></pre><pre class=" CodeMirror-line "
                                                                                  role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* GitHub：https://github.com/maomao124/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Date(创建日期)： 2022/5/17</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Time(创建时间)： 10:51</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Version(版本): 1.0</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Description(描述)： 无</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">RedisLock</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 尝试获取锁</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param timeoutSec 超时时间</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return boolean，成功返回true，否则返回false</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">tryLock</span>(<span
                class="cm-variable-3">long</span> <span class="cm-variable">timeoutSec</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span
                class="cm-variable">unlock</span>();</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 713px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 713px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>锁实现：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>;</span></pre></div><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Component</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">TimeUnit</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Project name(项目名称)：spring_boot_redis_hmdp_distributed_lock_realize_the_function_of_one_person_and_one_order</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Package(包名): mao.spring_boot_redis_hmdp.utils</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Class(类名): RedisLockImpl</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author(作者）: mao</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author QQ：1296193245</span></span></pre><pre class=" CodeMirror-line "
                                                                                  role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* GitHub：https://github.com/maomao124/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Date(创建日期)： 2022/5/17</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Time(创建时间)： 10:53</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Version(版本): 1.0</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Description(描述)： 简单分布式锁，非单例</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">RedisLockImpl</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">RedisLock</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 锁的名称</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">String</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* StringRedisTemplate</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 锁前缀</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span
                class="cm-variable">KEY_PREFIX</span> <span class="cm-operator">=</span> <span
                class="cm-string">"lock:"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 构造函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  锁的名称</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param stringRedisTemplate StringRedisTemplate</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">RedisLockImpl</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">name</span>, <span class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>)</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span
                class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">stringRedisTemplate</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">tryLock</span>(<span
                class="cm-variable-3">long</span> <span class="cm-variable">timeoutSec</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得线程标识</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">long</span> <span class="cm-variable">threadID</span> <span
                class="cm-operator">=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span
                class="cm-variable">getId</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//锁key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">KEY_PREFIX</span> <span
                class="cm-operator">+</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Boolean</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">setIfAbsent</span>(<span
                class="cm-variable">lockKey</span>, <span class="cm-variable-3">String</span>.<span class="cm-variable">valueOf</span>(<span
                class="cm-variable">threadID</span>),</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeoutSec</span>, <span class="cm-variable">TimeUnit</span>.<span
                class="cm-variable">SECONDS</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable-3">Boolean</span>.<span class="cm-variable">TRUE</span>.<span class="cm-variable">equals</span>(<span
                class="cm-variable">result</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">unlock</span>()</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//锁key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">KEY_PREFIX</span> <span
                class="cm-operator">+</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">delete</span>(<span class="cm-variable">lockKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1679px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1679px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>业务：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">conditions</span>.<span class="cm-variable">update</span>.<span
                class="cm-variable">UpdateWrapper</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">SeckillVoucher</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">VoucherOrder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">VoucherOrderMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">ISeckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IVoucherOrderService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisIDGenerator</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisLock</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisLockImpl</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">transaction</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Transactional</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">LocalDateTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span
                class="cm-keyword">class</span> <span class="cm-def">VoucherOrderServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">VoucherOrderMapper</span>, <span class="cm-variable">VoucherOrder</span><span
                class="cm-operator">&gt;</span> <span class="cm-keyword">implements</span> <span class="cm-variable">IVoucherOrderService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">ISeckillVoucherService</span> <span class="cm-variable">seckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisIDGenerator</span> <span
                class="cm-variable">redisIDGenerator</span>;</span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">seckillVoucher</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询优惠券</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SeckillVoucher</span> <span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">getById</span>(<span class="cm-variable">voucherId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"活动不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getBeginTime</span>().<span
                class="cm-variable">isAfter</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//未开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动未开始"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getEndTime</span>().<span
                class="cm-variable">isBefore</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动已经结束"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断库存是否充足</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getStock</span>() <span
                class="cm-operator">&lt;=</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//库存不足</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存不足"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-keyword">this</span>.<span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 创建订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param voucherId voucherId</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Transactional</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断当前优惠券用户是否已经下过单</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得用户id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userID</span> <span
                class="cm-operator">=</span> <span class="cm-number">5L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//todo:记得更改回来</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建锁对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">RedisLock</span> <span
                class="cm-variable">redisLock</span> <span class="cm-operator">=</span> <span
                class="cm-keyword">new</span> <span class="cm-variable">RedisLockImpl</span>(<span class="cm-string">"order:"</span> <span
                class="cm-operator">+</span> <span class="cm-variable">userID</span>, <span class="cm-variable">stringRedisTemplate</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//取得锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">isLock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisLock</span>.<span class="cm-variable">tryLock</span>(<span
                class="cm-number">500</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">isLock</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"不允许重复下单！"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取锁成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//synchronized (userID.toString().intern())</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">count</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">query</span>().<span
                class="cm-variable">eq</span>(<span class="cm-string">"user_id"</span>, <span
                class="cm-variable">userID</span>).<span class="cm-variable">eq</span>(<span class="cm-string">"voucher_id"</span>, <span
                class="cm-variable">voucherId</span>).<span class="cm-variable">count</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断长度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">count</span> <span
                class="cm-operator">&gt;</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//长度大于0，用户购买过</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"不能重复下单"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减库存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;</span><span class="cm-variable">SeckillVoucher</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">updateWrapper</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">updateWrapper</span>.<span class="cm-variable">setSql</span>(<span
                class="cm-string">"stock = stock - 1"</span>).<span class="cm-variable">eq</span>(<span
                class="cm-string">"voucher_id"</span>, <span class="cm-variable">voucherId</span>).<span
                class="cm-variable">gt</span>(<span class="cm-string">"stock"</span>, <span class="cm-number">0</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">update</span>(<span class="cm-variable">updateWrapper</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存扣减失败"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">VoucherOrder</span>();</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">orderID</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisIDGenerator</span>.<span
                class="cm-variable">nextID</span>(<span class="cm-string">"order"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setVoucherId</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setId</span>(<span
                class="cm-variable">orderID</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setUserId</span>(<span
                class="cm-variable">userID</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">save</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">orderID</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">finally</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">redisLock</span>.<span class="cm-variable">unlock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3105px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 3105px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p><span>再次改进：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>;</span></pre></div><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">lang</span>.<span class="cm-variable">UUID</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Component</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">TimeUnit</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Project name(项目名称)：spring_boot_redis_hmdp_distributed_lock_realize_the_function_of_one_person_and_one_order</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Package(包名): mao.spring_boot_redis_hmdp.utils</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Class(类名): RedisLockImpl</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author(作者）: mao</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author QQ：1296193245</span></span></pre><pre class=" CodeMirror-line "
                                                                                  role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* GitHub：https://github.com/maomao124/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Date(创建日期)： 2022/5/17</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Time(创建时间)： 10:53</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Version(版本): 1.0</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Description(描述)： 简单分布式锁，非单例</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">RedisLockImpl</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">RedisLock</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 锁的名称</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable-3">String</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* StringRedisTemplate</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span
                class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span class="cm-variable">ID_PREFIX</span> <span
                class="cm-operator">=</span> <span class="cm-variable">UUID</span>.<span
                class="cm-variable">randomUUID</span>().<span class="cm-variable">toString</span>(<span class="cm-atom">true</span>) <span
                class="cm-operator">+</span> <span class="cm-string">"-"</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 锁前缀</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span
                class="cm-variable">KEY_PREFIX</span> <span class="cm-operator">=</span> <span
                class="cm-string">"lock:"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 构造函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  锁的名称</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param stringRedisTemplate StringRedisTemplate</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">RedisLockImpl</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">name</span>, <span class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>)</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span
                class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">stringRedisTemplate</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">tryLock</span>(<span
                class="cm-variable-3">long</span> <span class="cm-variable">timeoutSec</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得线程标识</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">long</span> <span class="cm-variable">threadID</span> <span
                class="cm-operator">=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span
                class="cm-variable">getId</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//锁key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">KEY_PREFIX</span> <span
                class="cm-operator">+</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Boolean</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">setIfAbsent</span>(<span
                class="cm-variable">lockKey</span>, <span class="cm-variable-3">String</span>.<span class="cm-variable">valueOf</span>(<span
                class="cm-variable">threadID</span>),</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeoutSec</span>, <span class="cm-variable">TimeUnit</span>.<span
                class="cm-variable">SECONDS</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable-3">Boolean</span>.<span class="cm-variable">TRUE</span>.<span class="cm-variable">equals</span>(<span
                class="cm-variable">result</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">unlock</span>()</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 获取线程标识</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">threadID</span> <span class="cm-operator">=</span> <span
                class="cm-variable">ID_PREFIX</span> <span class="cm-operator">+</span> <span
                class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span
                class="cm-variable">getId</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//锁key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">KEY_PREFIX</span> <span
                class="cm-operator">+</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 获取锁中的标识</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">id</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">lockKey</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断锁是否是自己的，通过线程id来判断</span></span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">threadID</span>.<span class="cm-variable">equals</span>(<span
                class="cm-variable">id</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">lockKey</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1955px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1955px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>再次改进：</span></p>
        <p><span>lua脚本：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="lua"><div
                class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="lua"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">-- 这里的 KEYS[1] 就是锁的 key，这里的 ARGV[1] 就是当前线程标识</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">-- 获取锁中的标识，判断是否与当前线程标识一致</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span>(<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'get'</span>, <span class="cm-variable">KEYS</span>[<span
                class="cm-number">1</span>]) == <span class="cm-variable">ARGV</span>[<span class="cm-number">1</span>]) <span
                class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">-- 一致，则删除锁</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">redis.call</span>(<span class="cm-string">'del'</span>, <span
                class="cm-variable">KEYS</span>[<span class="cm-number">1</span>])</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">-- 不一致，则直接返回</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"><span
                class="cm-keyword">return</span> <span
                class="cm-number">0</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 184px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>业务：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>;</span></pre></div><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">lang</span>.<span class="cm-variable">UUID</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">lombok</span>.<span class="cm-variable">extern</span>.<span
                class="cm-variable">slf4j</span>.<span class="cm-variable">Slf4j</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">io</span>.<span class="cm-variable">ClassPathResource</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">script</span>.<span class="cm-variable">DefaultRedisScript</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Component</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">Collections</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">TimeUnit</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Project name(项目名称)：spring_boot_redis_hmdp_distributed_lock_realize_the_function_of_one_person_and_one_order</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Package(包名): mao.spring_boot_redis_hmdp.utils</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Class(类名): RedisLockImpl</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author(作者）: mao</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author QQ：1296193245</span></span></pre><pre class=" CodeMirror-line "
                                                                                  role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* GitHub：https://github.com/maomao124/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Date(创建日期)： 2022/5/17</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Time(创建时间)： 10:53</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Version(版本): 1.0</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Description(描述)： 简单分布式锁，非单例</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Slf4j</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span
                class="cm-keyword">class</span> <span class="cm-def">RedisLockImpl</span> <span class="cm-keyword">implements</span> <span
                class="cm-variable">RedisLock</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 锁的名称</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span
                class="cm-variable">name</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* StringRedisTemplate</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">final</span> <span class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span
                class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span class="cm-variable">ID_PREFIX</span> <span
                class="cm-operator">=</span> <span class="cm-variable">UUID</span>.<span
                class="cm-variable">randomUUID</span>().<span class="cm-variable">toString</span>(<span class="cm-atom">true</span>) <span
                class="cm-operator">+</span> <span class="cm-string">"-"</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span
                class="cm-keyword">final</span> <span class="cm-variable">DefaultRedisScript</span><span
                class="cm-operator">&lt;</span><span class="cm-variable-3">Long</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">UNLOCK_SCRIPT</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">static</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//创建对象</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UNLOCK_SCRIPT</span> <span class="cm-operator">=</span> <span
                class="cm-keyword">new</span> <span class="cm-variable">DefaultRedisScript</span><span
                class="cm-operator">&lt;&gt;</span>();</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//加载类路径下的资源</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UNLOCK_SCRIPT</span>.<span class="cm-variable">setLocation</span>(<span
                class="cm-keyword">new</span> <span class="cm-variable">ClassPathResource</span>(<span
                class="cm-string">"unlock.lua"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置返回值的类型</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UNLOCK_SCRIPT</span>.<span class="cm-variable">setResultType</span>(<span
                class="cm-variable-3">Long</span>.<span class="cm-keyword">class</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 锁前缀</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span
                class="cm-variable">KEY_PREFIX</span> <span class="cm-operator">=</span> <span
                class="cm-string">"lock:"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 构造函数</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  锁的名称</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param stringRedisTemplate StringRedisTemplate</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">RedisLockImpl</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">name</span>, <span class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>)</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span
                class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">stringRedisTemplate</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">tryLock</span>(<span
                class="cm-variable-3">long</span> <span class="cm-variable">timeoutSec</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得线程标识</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">long</span> <span class="cm-variable">threadID</span> <span
                class="cm-operator">=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span
                class="cm-variable">getId</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//锁key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">KEY_PREFIX</span> <span
                class="cm-operator">+</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Boolean</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">setIfAbsent</span>(<span
                class="cm-variable">lockKey</span>, <span class="cm-variable-3">String</span>.<span class="cm-variable">valueOf</span>(<span
                class="cm-variable">threadID</span>),</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">timeoutSec</span>, <span class="cm-variable">TimeUnit</span>.<span
                class="cm-variable">SECONDS</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable-3">Boolean</span>.<span class="cm-variable">TRUE</span>.<span class="cm-variable">equals</span>(<span
                class="cm-variable">result</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">unlock</span>()</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 获取线程标识</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">threadID</span> <span class="cm-operator">=</span> <span
                class="cm-variable">ID_PREFIX</span> <span class="cm-operator">+</span> <span
                class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span
                class="cm-variable">getId</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//锁key</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">lockKey</span> <span
                class="cm-operator">=</span> <span class="cm-variable">KEY_PREFIX</span> <span
                class="cm-operator">+</span> <span class="cm-variable">name</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">/*// 获取锁中的标识</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">String id = stringRedisTemplate.opsForValue().get(lockKey);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断锁是否是自己的，通过线程id来判断</span></span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">if (threadID.equals(id))</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">stringRedisTemplate.delete(lockKey);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">}*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//执行lua脚本</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">execute</span>(<span class="cm-variable">UNLOCK_SCRIPT</span>, <span
                class="cm-variable">Collections</span>.<span class="cm-variable">singletonList</span>(<span
                class="cm-variable">lockKey</span>), <span class="cm-variable">threadID</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">result</span> <span
                class="cm-operator">==</span> <span class="cm-atom">null</span> <span
                class="cm-operator">||</span> <span class="cm-variable">result</span> <span
                class="cm-operator">==</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放到了别人的锁</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">debug</span>(<span
                class="cm-string">"释放锁异常"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2507px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 2507px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h3 id='redisson'><span>Redisson</span></h3>
        <p><span>依赖：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="xml"><div
                class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">&lt;!--spring boot redisson 依赖--&gt;</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">dependency</span><span
                class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span>org.redisson<span
                class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">groupId</span><span
                class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">artifactId</span><span
                class="cm-tag cm-bracket">&gt;</span>redisson-spring-boot-starter<span
                class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">artifactId</span><span
                class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span>3.17.0<span
                class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">version</span><span
                class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">dependency</span><span
                class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>配置：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">config</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span
                class="cm-variable">redisson</span>.<span class="cm-variable">Redisson</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span
                class="cm-variable">redisson</span>.<span class="cm-variable">api</span>.<span class="cm-variable">RedissonClient</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span
                class="cm-variable">redisson</span>.<span class="cm-variable">config</span>.<span class="cm-variable">Config</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">context</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Bean</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">context</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Configuration</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Project name(项目名称)：spring_boot_redis_hmdp_distributed_lock_based_on_redisson</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Package(包名): mao.spring_boot_redis_hmdp.config</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Class(类名): RedissonConfig</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author(作者）: mao</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author QQ：1296193245</span></span></pre><pre class=" CodeMirror-line "
                                                                                  role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* GitHub：https://github.com/maomao124/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Date(创建日期)： 2022/5/17</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Time(创建时间)： 13:40</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Version(版本): 1.0</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Description(描述)： Redisson的配置</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Configuration</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">RedissonConfig</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* Redisson配置</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return RedissonClient</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">RedissonClient</span> <span
                class="cm-variable">redissonClient</span>()</span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//配置类</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Config</span> <span class="cm-variable">config</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Config</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//添加redis地址，用config.useClusterServers()添加集群地址</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">config</span>.<span class="cm-variable">useSingleServer</span>().<span
                class="cm-variable">setAddress</span>(<span class="cm-string">"redis://127.0.0.1:6379"</span>).<span
                class="cm-variable">setPassword</span>(<span class="cm-string">"123456"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建客户端</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Redisson</span>.<span class="cm-variable">create</span>(<span class="cm-variable">config</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 943px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 943px;"></div></div></div></pre>
        <p><span>使用：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@Resource</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">private</span> <span class="cm-variable">RedissonClient</span> <span
                class="cm-variable">redissonClient</span>;</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Test</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-variable-3">void</span> <span class="cm-def">testRedisson</span>() <span class="cm-keyword">throws</span> <span
                class="cm-variable">InterruptedException</span> {</span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// 获取锁（可重入），指定锁的名称</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">RLock</span> <span
                class="cm-variable">lock</span> <span class="cm-operator">=</span> <span class="cm-variable">redissonClient</span>.<span
                class="cm-variable">getLock</span>(<span class="cm-string">"anyLock"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// 尝试获取锁，参数分别是：获取锁的最大等待时间（期间会重试），锁自动释放时间，时间单位</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-variable-3">boolean</span> <span class="cm-variable">isLock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">lock</span>.<span
                class="cm-variable">tryLock</span>(<span class="cm-number">1</span>, <span class="cm-number">10</span>, <span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// 判断释放获取成功</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"><span
                class="cm-keyword">if</span>(<span class="cm-variable">isLock</span>){</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">System</span>.<span
                class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span
                class="cm-string">"执行业务"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">}<span
                class="cm-keyword">finally</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 释放锁</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-variable">lock</span>.<span class="cm-variable">unlock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 437px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 437px;"></div></div></div></pre>
        <p>&nbsp;</p><h4 id='相关概念'><span>相关概念</span></h4>
        <ul>
            <li><span>可重入：利用 hash 结构记录线程 id 和重入次数。每次获取锁时，先判断锁是否存在，如果不存在，则直接获取，如果已经存在，且线程标识为当前线程，则可以再次获取，并将重入次数加 1。释放锁时，每释放一次，重入次数减 1，直至重入次数减为 0，则证明所有的业务已经执行结束，则可以直接释放锁。</span>
            </li>
            <li><span>可重试：在第一次尝试获取锁失败后，并不是立即失败，而是去等待释放锁的信号（利用了 Redis 中 PubSub 机制）。而获取锁成功的线程在释放锁的时候，就会向等待中的线程发送一条消息，等待中的线程捕获到消息后，就可以重新尝试获取锁。如果重试失败，则会继续等待释放锁的信号，然后再去重试。当然，重试并不是无限次的，会有一个等待时间，如果超过等待时间，就结束重试。</span>
            </li>
            <li><span>超时续约：利用watchDog，每隔一段时间（releaseTime  / 3），重置超时时间</span></li>
        </ul>
        <p>&nbsp;</p>
        <p>&nbsp;</p><h4 id='实现-4'><span>实现</span></h4>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">conditions</span>.<span class="cm-variable">update</span>.<span
                class="cm-variable">UpdateWrapper</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">SeckillVoucher</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">VoucherOrder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">VoucherOrderMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">ISeckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IVoucherOrderService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisIDGenerator</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisLock</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisLockImpl</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span
                class="cm-variable">redisson</span>.<span class="cm-variable">api</span>.<span
                class="cm-variable">RLock</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">org</span>.<span class="cm-variable">redisson</span>.<span
                class="cm-variable">api</span>.<span class="cm-variable">RedissonClient</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">transaction</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Transactional</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">LocalDateTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span
                class="cm-keyword">class</span> <span class="cm-def">VoucherOrderServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">VoucherOrderMapper</span>, <span class="cm-variable">VoucherOrder</span><span
                class="cm-operator">&gt;</span> <span class="cm-keyword">implements</span> <span class="cm-variable">IVoucherOrderService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">ISeckillVoucherService</span> <span class="cm-variable">seckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisIDGenerator</span> <span
                class="cm-variable">redisIDGenerator</span>;</span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedissonClient</span> <span class="cm-variable">redissonClient</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">seckillVoucher</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询优惠券</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SeckillVoucher</span> <span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">getById</span>(<span class="cm-variable">voucherId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"活动不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getBeginTime</span>().<span
                class="cm-variable">isAfter</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//未开始</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动未开始"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getEndTime</span>().<span
                class="cm-variable">isBefore</span>(<span class="cm-variable">LocalDateTime</span>.<span
                class="cm-variable">now</span>()))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"秒杀活动已经结束"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断库存是否充足</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">seckillVoucher</span>.<span class="cm-variable">getStock</span>() <span
                class="cm-operator">&lt;=</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//库存不足</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存不足"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-keyword">this</span>.<span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 创建订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param voucherId voucherId</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Transactional</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断当前优惠券用户是否已经下过单</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得用户id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userID</span> <span
                class="cm-operator">=</span> <span class="cm-number">5L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//todo:记得更改回来</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">/*//创建锁对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">RedisLock redisLock = new RedisLockImpl("order:" + userID, stringRedisTemplate);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//取得锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">boolean isLock = redisLock.tryLock(1500);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">if (!isLock)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">return Result.fail("不允许重复下单！");</span></span></pre><pre class=" CodeMirror-line "
                                                                                           role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">}*/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//redisson锁</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RLock</span> <span class="cm-variable">lock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redissonClient</span>.<span class="cm-variable">getLock</span>(<span
                class="cm-string">"lock:order:"</span> <span class="cm-operator">+</span> <span class="cm-variable">userID</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//尝试获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//仅当调用时它是空闲的时才获取锁。</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//如果锁可用，则获取锁并立即返回值为true</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//如果锁不可用，则此方法将立即返回值false</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">tryLock</span> <span class="cm-operator">=</span> <span
                class="cm-variable">lock</span>.<span class="cm-variable">tryLock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否获取成功</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">tryLock</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"不允许重复下单！"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取锁成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//synchronized (userID.toString().intern())</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">count</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">query</span>().<span
                class="cm-variable">eq</span>(<span class="cm-string">"user_id"</span>, <span
                class="cm-variable">userID</span>).<span class="cm-variable">eq</span>(<span class="cm-string">"voucher_id"</span>, <span
                class="cm-variable">voucherId</span>).<span class="cm-variable">count</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断长度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">count</span> <span
                class="cm-operator">&gt;</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//长度大于0，用户购买过</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"不能重复下单"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减库存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;</span><span class="cm-variable">SeckillVoucher</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">updateWrapper</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">updateWrapper</span>.<span class="cm-variable">setSql</span>(<span
                class="cm-string">"stock = stock - 1"</span>).<span class="cm-variable">eq</span>(<span
                class="cm-string">"voucher_id"</span>, <span class="cm-variable">voucherId</span>).<span
                class="cm-variable">gt</span>(<span class="cm-string">"stock"</span>, <span class="cm-number">0</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">update</span>(<span class="cm-variable">updateWrapper</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"库存扣减失败"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">VoucherOrder</span>();</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//生成id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">orderID</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisIDGenerator</span>.<span
                class="cm-variable">nextID</span>(<span class="cm-string">"order"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setVoucherId</span>(<span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setId</span>(<span
                class="cm-variable">orderID</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setUserId</span>(<span
                class="cm-variable">userID</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">save</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">orderID</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">finally</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//redisLock.unlock();</span></span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">lock</span>.<span class="cm-variable">unlock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3542px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 3542px;"></div></div></div></pre>
        <p>&nbsp;</p><h4 id='redisson-可重入锁'><span>Redisson 可重入锁</span></h4>
        <p><span>我们可以在获取锁的时候，首先判断锁是否已经被占用，如果已经被占用，判断是否是当前线程所占用的，如果是同一个线程占用，也会让其获取到锁，但是会额外增加一个计数器，用于记录重入的次数，即当前线程总共获取了几次锁。当前线程每获取一次锁，计数器便加1，而在释放锁时，每释放一次锁，计数器就会减1，直至计数器为 0 时，将当前锁直接删除。那么现在，我们不仅要在锁中记录获取锁的线程，还要记录当前线程重入次数，即获取了几次锁，显然，String 类型的数据结构并不满足这个业务需求，这里可以使用 Hash 类型进行存储，这样就可以在 key 的位置，记录锁的名称，在 field 的位置记录线程标识，在 value 的位置记录锁重入次数。</span>
        </p>
        <p>&nbsp;</p>
        <p><span>获取锁：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="lua"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="lua"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">local</span> <span class="cm-variable">key</span> = <span
                class="cm-variable">KEYS</span>[<span class="cm-number">1</span>]; &nbsp;<span class="cm-comment">-- 锁的key</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">local</span> <span class="cm-variable">threadId</span> = <span class="cm-variable">ARGV</span>[<span
                class="cm-number">1</span>]; <span class="cm-comment">-- 线程唯一标识</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">local</span> <span class="cm-variable">releaseTime</span> = <span
                class="cm-variable">ARGV</span>[<span class="cm-number">2</span>]; <span
                class="cm-comment">-- 锁的自动释放时间</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">-- 判断是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span>(<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'exists'</span>, <span
                class="cm-variable">key</span>) == <span class="cm-number">0</span>) <span
                class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">-- 不存在，获取锁</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'hset'</span>, <span class="cm-variable">key</span>, <span
                class="cm-variable">threadId</span>, <span class="cm-string">'1'</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">-- 设置有效期</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'expire'</span>, <span
                class="cm-variable">key</span>, <span class="cm-variable">releaseTime</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-number">1</span>; <span
                class="cm-comment">-- 返回结果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">-- 锁已经存在，判断threadId是否是自己</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span>(<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'hexists'</span>, <span
                class="cm-variable">key</span>, <span class="cm-variable">threadId</span>) == <span
                class="cm-number">1</span>) <span class="cm-keyword">then</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">-- 存在，获取锁，重入次数+1</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'hincrby'</span>, <span
                class="cm-variable">key</span>, <span class="cm-variable">threadId</span>, <span
                class="cm-string">'1'</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">-- 设置有效期</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'expire'</span>, <span
                class="cm-variable">key</span>, <span class="cm-variable">releaseTime</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-number">1</span>; <span
                class="cm-comment">-- 返回结果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">return</span> <span class="cm-number">0</span>; <span class="cm-comment">-- 代码走到这里，说明获取锁的不是自己，获取锁失败</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 506px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 506px;"></div></div></div></pre>
        <p><span>释放锁：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="lua"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="lua"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">local</span> <span class="cm-variable">key</span> = <span
                class="cm-variable">KEYS</span>[<span class="cm-number">1</span>]; &nbsp;<span class="cm-comment">-- 锁的key</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">local</span> <span class="cm-variable">threadId</span> = <span class="cm-variable">ARGV</span>[<span
                class="cm-number">1</span>]; <span class="cm-comment">-- 线程唯一标识</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">local</span> <span class="cm-variable">releaseTime</span> = <span
                class="cm-variable">ARGV</span>[<span class="cm-number">2</span>]; <span
                class="cm-comment">-- 锁的自动释放时间</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">-- 判断当前锁是否还是被自己持有</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span>(<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'hexists'</span>, <span
                class="cm-variable">key</span>, <span class="cm-variable">threadId</span>) == <span
                class="cm-number">0</span>) <span class="cm-keyword">then</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-keyword">nil</span>; <span class="cm-comment">-- 如果已经不是自己，则直接返回</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">-- 是自己的锁，则重入次数-1</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span
                class="cm-variable">count</span> = <span class="cm-variable">redis.call</span>(<span class="cm-string">'hincrby'</span>, <span
                class="cm-variable">key</span>, <span class="cm-variable">threadId</span>, -<span
                class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 判断重入次数是否已经为0</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">if</span>(<span class="cm-variable">count</span> &gt; <span
                class="cm-number">0</span>) <span class="cm-keyword">then</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">-- 大于0说明不能是释放锁，重置有效期然后返回</span></span></pre><pre class=" CodeMirror-line "
                                                                                    role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'expire'</span>, <span
                class="cm-variable">threadId</span>, <span class="cm-variable">releaseTime</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-keyword">nil</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'del'</span>, <span class="cm-variable">key</span>); <span
                class="cm-comment">-- 等于 0 说明可以释放锁，直接删除</span></span></pre><pre class=" CodeMirror-line "
                                                                                role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-keyword">nil</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">end</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 437px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 437px;"></div></div></div></pre>
        <p>&nbsp;</p><h4 id='联锁'><span>联锁</span></h4>
        <p><span>配置：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@Configuration</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">RedissonConfig</span> {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">RedissonClient</span> <span
                class="cm-variable">redissonClient</span>(){</span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Config</span> <span
                class="cm-variable">config</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">Config</span>();</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">config</span>.<span class="cm-variable">useSingleServer</span>().<span
                class="cm-variable">setAddress</span>(<span class="cm-string">"redis://虚拟机ip:6379"</span>).<span
                class="cm-variable">setPassword</span>(<span class="cm-string">"密码"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Redisson</span>.<span class="cm-variable">create</span>(<span
                class="cm-variable">config</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">RedissonClient</span> <span
                class="cm-variable">redissonClient2</span>(){</span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Config</span> <span
                class="cm-variable">config</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">Config</span>();</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">config</span>.<span class="cm-variable">useSingleServer</span>().<span
                class="cm-variable">setAddress</span>(<span class="cm-string">"redis://虚拟机ip:6380"</span>).<span
                class="cm-variable">setPassword</span>(<span class="cm-string">"密码"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Redisson</span>.<span class="cm-variable">create</span>(<span
                class="cm-variable">config</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">RedissonClient</span> <span
                class="cm-variable">redissonClient3</span>(){</span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Config</span> <span
                class="cm-variable">config</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">Config</span>();</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">config</span>.<span class="cm-variable">useSingleServer</span>().<span
                class="cm-variable">setAddress</span>(<span class="cm-string">"redis://虚拟机ip:6381"</span>).<span
                class="cm-variable">setPassword</span>(<span class="cm-string">"密码"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Redisson</span>.<span class="cm-variable">create</span>(<span
                class="cm-variable">config</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 575px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 575px;"></div></div></div></pre>
        <p><span>测试：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@Slf4j</span></span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-meta">@SpringBootTest</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">class</span> <span class="cm-def">RedissonTest</span> {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedissonClient</span> <span class="cm-variable">redissonClient</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedissonClient</span> <span class="cm-variable">redissonClient2</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedissonClient</span> <span class="cm-variable">redissonClient3</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable">RLock</span> <span
                class="cm-variable">lock</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@BeforeEach</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span
                class="cm-variable">setUp</span>() {</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RLock</span> <span class="cm-variable">lock1</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redissonClient</span>.<span class="cm-variable">getLock</span>(<span
                class="cm-string">"order"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">RLock</span> <span
                class="cm-variable">lock2</span> <span class="cm-operator">=</span> <span class="cm-variable">redissonClient2</span>.<span
                class="cm-variable">getLock</span>(<span class="cm-string">"order"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RLock</span> <span class="cm-variable">lock3</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redissonClient3</span>.<span class="cm-variable">getLock</span>(<span
                class="cm-string">"order"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">lock</span> <span class="cm-operator">=</span> <span class="cm-variable">redissonClient</span>.<span
                class="cm-variable">getMultiLock</span>(<span class="cm-variable">lock1</span>, <span
                class="cm-variable">lock2</span>, <span class="cm-variable">lock3</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Test</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span
                class="cm-variable">method1</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">InterruptedException</span> {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 尝试获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">isLock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">lock</span>.<span
                class="cm-variable">tryLock</span>(<span class="cm-number">1L</span>, <span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">isLock</span>) {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">error</span>(<span class="cm-string">"获取锁失败 .... 1"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">info</span>(<span class="cm-string">"获取锁成功 .... 1"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">method2</span>();</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">info</span>(<span class="cm-string">"开始执行业务 ... 1"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span
                class="cm-keyword">finally</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">warn</span>(<span class="cm-string">"准备释放锁 .... 1"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">lock</span>.<span class="cm-variable">unlock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-variable-3">void</span> <span class="cm-variable">method2</span>() {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 尝试获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">isLock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">lock</span>.<span
                class="cm-variable">tryLock</span>();</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">isLock</span>) {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">error</span>(<span class="cm-string">"获取锁失败 .... 2"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">info</span>(<span class="cm-string">"获取锁成功 .... 2"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">info</span>(<span class="cm-string">"开始执行业务 ... 2"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span
                class="cm-keyword">finally</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">warn</span>(<span class="cm-string">"准备释放锁 .... 2"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">lock</span>.<span class="cm-variable">unlock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1311px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1311px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h2 id='秒杀优化'><span>秒杀优化</span></h2>
        <p>&nbsp;</p>
        <p><span>业务：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">conditions</span>.<span class="cm-variable">update</span>.<span
                class="cm-variable">UpdateWrapper</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">UserDTO</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">SeckillVoucher</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">VoucherOrder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">VoucherOrderMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">ISeckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IVoucherOrderService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisConstants</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisIDGenerator</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">UserHolder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span
                class="cm-variable">redisson</span>.<span class="cm-variable">api</span>.<span
                class="cm-variable">RLock</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">org</span>.<span class="cm-variable">redisson</span>.<span
                class="cm-variable">api</span>.<span class="cm-variable">RedissonClient</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">io</span>.<span class="cm-variable">ClassPathResource</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">script</span>.<span class="cm-variable">DefaultRedisScript</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">transaction</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Transactional</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">PostConstruct</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">LocalDateTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">Collections</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">ArrayBlockingQueue</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">BlockingQueue</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">ExecutorService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">Executors</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span
                class="cm-keyword">class</span> <span class="cm-def">VoucherOrderServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">VoucherOrderMapper</span>, <span class="cm-variable">VoucherOrder</span><span
                class="cm-operator">&gt;</span> <span class="cm-keyword">implements</span> <span class="cm-variable">IVoucherOrderService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">ISeckillVoucherService</span> <span class="cm-variable">seckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisIDGenerator</span> <span
                class="cm-variable">redisIDGenerator</span>;</span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedissonClient</span> <span class="cm-variable">redissonClient</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span
                class="cm-keyword">final</span> <span class="cm-variable">DefaultRedisScript</span><span
                class="cm-operator">&lt;</span><span class="cm-variable-3">Long</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">SECKILL_SCRIPT</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 阻塞队列</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">final</span> <span class="cm-variable">BlockingQueue</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">VoucherOrder</span><span class="cm-operator">&gt;</span> <span class="cm-variable">blockingQueue</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ArrayBlockingQueue</span><span
                class="cm-operator">&lt;&gt;</span>(<span class="cm-number">1024</span> <span
                class="cm-operator">*</span> <span class="cm-number">1024</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 线程池</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable">ExecutorService</span> <span
                class="cm-variable">SECKILL_ORDER_EXECUTOR</span> <span class="cm-operator">=</span> <span
                class="cm-variable">Executors</span>.<span class="cm-variable">newSingleThreadExecutor</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">static</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//创建对象</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">SECKILL_SCRIPT</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">DefaultRedisScript</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//加载</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SECKILL_SCRIPT</span>.<span
                class="cm-variable">setLocation</span>(<span class="cm-keyword">new</span> <span class="cm-variable">ClassPathResource</span>(<span
                class="cm-string">"seckill.lua"</span>));</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置返回类型</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SECKILL_SCRIPT</span>.<span
                class="cm-variable">setResultType</span>(<span class="cm-variable-3">Long</span>.<span
                class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@PostConstruct</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span
                class="cm-variable">init</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SECKILL_ORDER_EXECUTOR</span>.<span
                class="cm-variable">submit</span>((<span class="cm-variable">Runnable</span>) <span class="cm-variable">VoucherOrderHandler</span>::<span
                class="cm-keyword">new</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-keyword">class</span> <span class="cm-def">VoucherOrderHandler</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">Runnable</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span
                class="cm-variable-3">void</span> <span class="cm-variable">run</span>()</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//系统启动开始，便不断从阻塞队列中获取优惠券订单信息</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">while</span> (<span class="cm-atom">true</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取订单信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span> <span
                class="cm-operator">=</span> <span class="cm-variable">blockingQueue</span>.<span class="cm-variable">take</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">voucherOrder</span>);</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">debug</span>(<span class="cm-string">"异步订单创建任务执行成功！订单id："</span> <span
                class="cm-operator">+</span> <span class="cm-variable">voucherOrder</span>.<span class="cm-variable">getVoucherId</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span
                class="cm-variable">e</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  @Override</span></span></pre><pre class=" CodeMirror-line "
                                                                                role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp;  public Result seckillVoucher(Long voucherId)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //查询优惠券</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  SeckillVoucher seckillVoucher = seckillVoucherService.getById(voucherId);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断是否存在</span></span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (seckillVoucher == null)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("活动不存在");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断是否开始</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (seckillVoucher.getBeginTime().isAfter(LocalDateTime.now()))</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //未开始</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("秒杀活动未开始");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断是否结束</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (seckillVoucher.getEndTime().isBefore(LocalDateTime.now()))</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //结束</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("秒杀活动已经结束");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断库存是否充足</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (seckillVoucher.getStock() &lt;= 0)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //库存不足</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("库存不足");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //创建订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  return this.createVoucherOrder(voucherId);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"><span
                class="cm-comment">//</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  /**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; * 创建订单</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; *</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; * @param voucherId voucherId</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; * @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; */</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  @Transactional</span></span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp;  public Result createVoucherOrder(Long voucherId)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断当前优惠券用户是否已经下过单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //获得用户id</span></span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  Long userID = 5L;</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //todo:记得更改回来</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  /*//创建锁对象</span></span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  RedisLock redisLock = new RedisLockImpl("order:" + userID, stringRedisTemplate);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //取得锁</span></span></pre><pre class=" CodeMirror-line "
                                                                                          role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  boolean isLock = redisLock.tryLock(1500);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (!isLock)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("不允许重复下单！");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }*/</span></span></pre><pre class=" CodeMirror-line "
                                                                                        role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">//</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //redisson锁</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  RLock lock = redissonClient.getLock("lock:order:" + userID);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //尝试获取锁</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //仅当调用时它是空闲的时才获取锁。</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //如果锁可用，则获取锁并立即返回值为true</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //如果锁不可用，则此方法将立即返回值false</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  boolean tryLock = lock.tryLock();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断是否获取成功</span></span></pre><pre class=" CodeMirror-line "
                                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (!tryLock)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("不允许重复下单！");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //获取锁成功</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //synchronized (userID.toString().intern())</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  try</span></span></pre><pre class=" CodeMirror-line "
                                                                                        role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //查询数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Long count = this.query().eq("user_id", userID).eq("voucher_id", voucherId).count();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //判断长度</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  if (count &gt; 0)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //长度大于0，用户购买过</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("不能重复下单");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //扣减库存</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  UpdateWrapper&lt;SeckillVoucher&gt; updateWrapper = new UpdateWrapper&lt;&gt;();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  updateWrapper.setSql("stock = stock - 1").eq("voucher_id", voucherId).gt("stock", 0);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  boolean update = seckillVoucherService.update(updateWrapper);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  if (!update)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //失败</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("库存扣减失败");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //扣减成功</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //生成订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  VoucherOrder voucherOrder = new VoucherOrder();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //生成id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Long orderID = redisIDGenerator.nextID("order");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  voucherOrder.setVoucherId(voucherId);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  voucherOrder.setId(orderID);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //设置用户</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  voucherOrder.setUserId(userID);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //保存订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  this.save(voucherOrder);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //返回</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.ok(orderID);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  finally</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //释放锁</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //redisLock.unlock();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  lock.unlock();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">seckillVoucher</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">s</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">SECKILL_STOCK_KEY</span> <span class="cm-operator">+</span> <span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断此优惠券是否存在</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">s</span> <span
                class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"此优惠券不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UserDTO</span> <span class="cm-variable">user</span> <span
                class="cm-operator">=</span> <span class="cm-variable">UserHolder</span>.<span class="cm-variable">getUser</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得用户ID</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//Long userID = user.getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userID</span> <span
                class="cm-operator">=</span> <span class="cm-number">5L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//todo:记得更改</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//执行lua脚本</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">execute</span>(<span class="cm-variable">SECKILL_SCRIPT</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Collections</span>.<span class="cm-variable">emptyList</span>(),</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherId</span>.<span class="cm-variable">toString</span>(), <span
                class="cm-variable">userID</span>.<span class="cm-variable">toString</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">result</span> <span
                class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"订单异常"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 判断结果是否为 0</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">result</span> <span
                class="cm-operator">!=</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 不为 0 ，代表没有购买资格</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Result</span>.<span class="cm-variable">fail</span>(<span
                class="cm-variable">result</span> <span class="cm-operator">==</span> <span
                class="cm-number">1</span> <span class="cm-operator">?</span> <span
                class="cm-string">"库存不足！"</span> : <span class="cm-string">"不能重复下单!"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//为0，创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">orderId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisIDGenerator</span>.<span
                class="cm-variable">nextID</span>(<span class="cm-string">"oder"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">VoucherOrder</span>();</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">voucherOrder</span>.<span
                class="cm-variable">setVoucherId</span>(<span class="cm-variable">voucherId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setUserId</span>(<span
                class="cm-variable">userID</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">voucherOrder</span>.<span
                class="cm-variable">setId</span>(<span class="cm-variable">orderId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//加入到阻塞队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">blockingQueue</span>.<span
                class="cm-variable">add</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Result</span>.<span class="cm-variable">ok</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 创建订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param voucherOrder VoucherOrder</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Transactional</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">protected</span> <span class="cm-variable-3">void</span> <span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断当前优惠券用户是否已经下过单</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得用户id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userID</span> <span
                class="cm-operator">=</span> <span class="cm-number">5L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//todo:记得更改回来</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">/*//创建锁对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">RedisLock redisLock = new RedisLockImpl("order:" + userID, stringRedisTemplate);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//取得锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">boolean isLock = redisLock.tryLock(1500);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">if (!isLock)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">return Result.fail("不允许重复下单！");</span></span></pre><pre class=" CodeMirror-line "
                                                                                           role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">}*/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//redisson锁</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RLock</span> <span class="cm-variable">lock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redissonClient</span>.<span class="cm-variable">getLock</span>(<span
                class="cm-string">"lock:order:"</span> <span class="cm-operator">+</span> <span class="cm-variable">userID</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//尝试获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//仅当调用时它是空闲的时才获取锁。</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//如果锁可用，则获取锁并立即返回值为true</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//如果锁不可用，则此方法将立即返回值false</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">tryLock</span> <span class="cm-operator">=</span> <span
                class="cm-variable">lock</span>.<span class="cm-variable">tryLock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否获取成功</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">tryLock</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取锁成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//synchronized (userID.toString().intern())</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">voucherOrder</span>.<span class="cm-variable">getVoucherId</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">count</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">query</span>().<span
                class="cm-variable">eq</span>(<span class="cm-string">"user_id"</span>, <span
                class="cm-variable">userID</span>).<span class="cm-variable">eq</span>(<span class="cm-string">"voucher_id"</span>, <span
                class="cm-variable">voucherId</span>).<span class="cm-variable">count</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断长度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">count</span> <span
                class="cm-operator">&gt;</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//长度大于0，用户购买过</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减库存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;</span><span class="cm-variable">SeckillVoucher</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">updateWrapper</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">updateWrapper</span>.<span class="cm-variable">setSql</span>(<span
                class="cm-string">"stock = stock - 1"</span>).<span class="cm-variable">eq</span>(<span
                class="cm-string">"voucher_id"</span>, <span class="cm-variable">voucherId</span>).<span
                class="cm-variable">gt</span>(<span class="cm-string">"stock"</span>, <span class="cm-number">0</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">update</span>(<span class="cm-variable">updateWrapper</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">save</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">finally</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//redisLock.unlock();</span></span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">lock</span>.<span class="cm-variable">unlock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 7521px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 7521px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>lua脚本：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="lua"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="lua"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">-- 优惠券id</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span
                class="cm-variable">voucherId</span> = <span class="cm-variable">ARGV</span>[<span
                class="cm-number">1</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 用户id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">local</span> <span class="cm-variable">userId</span> = <span
                class="cm-variable">ARGV</span>[<span class="cm-number">2</span>]</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">-- 库存key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span
                class="cm-variable">stockKey</span> = <span class="cm-string">"seckill:stock:"</span>..<span
                class="cm-variable">voucherId</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-comment">-- 订单key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span
                class="cm-variable">orderKey</span> = <span class="cm-string">"seckill:order:"</span>..<span
                class="cm-variable">voucherId</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">-- 判断库存是否充足</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"><span
                class="cm-keyword">if</span>(<span class="cm-builtin">tonumber</span>(<span class="cm-variable">redis.call</span>(<span
                class="cm-string">'get'</span>, <span class="cm-variable">stockKey</span>)) &lt;= <span
                class="cm-number">0</span>) <span class="cm-keyword">then</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-number">1</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">-- 判断用户是否已经下过单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span>(<span
                class="cm-variable">redis.call</span>(<span class="cm-string">'sismember'</span>, <span
                class="cm-variable">orderKey</span>, <span class="cm-variable">userId</span>) == <span
                class="cm-number">1</span>) <span class="cm-keyword">then</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-number">2</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">-- 扣减库存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">redis.call</span>(<span
                class="cm-string">'incrby'</span>, <span class="cm-variable">stockKey</span>, -<span
                class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">-- 将 userId 存入当前优惠券的 set 集合</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">redis.call</span>(<span
                class="cm-string">'sadd'</span>, <span class="cm-variable">orderKey</span>, <span class="cm-variable">userId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">return</span> <span
                class="cm-number">0</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 621px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 621px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <h3 id='思路'><span>思路</span></h3>
        <ul>
            <li><span>先利用Redis完成库存余量、一人一单判断，完成抢单业务</span></li>
            <li><span>再将下单业务放入阻塞队列，利用独立线程异步下单</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='存在问题'><span>存在问题</span></h3>
        <ul>
            <li><span>内存限制问题</span></li>
            <li><span>数据安全问题。我们是基于内存保存的订单信息，如果服务突然宕机，那么内存中的订单信息也就丢失了</span></li>
        </ul>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h2 id='消息队列实现秒杀'><span>消息队列实现秒杀</span></h2>
        <p>&nbsp;</p>
        <ul>
            <li><span>消息队列是在 JVM 以外的独立服务，所以不受 JVM 内存的限制</span></li>
            <li><span>消息队列不仅仅做数据存储，还需要确保数据安全，存入到消息队列中的所有消息都需要做持久化，这样不管是服务宕机还是重启，数据都不会丢失。而且消息队列还会在消息投递给消费者后，要求消费者做消息确认，如果消费者没有确认，那么这条消息就会一直存在于消息队列中，下一次会继续投递给消费者，让消费者继续处理，直到消息被成功处理。</span>
            </li>
        </ul>
        <h3 id='redis-提供的消息队列'><span>Redis 提供的消息队列</span></h3>
        <ul>
            <li><span>list 结构：基于 List 结构模拟消息队列</span></li>
            <li><span>PubSub：基本的点对点消息队列</span></li>
            <li><span>Stream：比较完善的消息队列模型</span></li>
            <li></li>
        </ul>
        <h3 id='list-结构消息队列'><span>list 结构消息队列</span></h3>
        <p><span>优点：</span></p>
        <ul>
            <li><span>利用 Redis 存储，不受限于 JVM 内存上限</span></li>
            <li><span>基于 Redis 的持久化机制，数据安全性有保证</span></li>
            <li><span>可以满足消息有序性</span></li>
        </ul>
        <p><span>缺点：</span></p>
        <ul>
            <li><span>无法避免消息丢失。假设某个消费者从消息队列（List 结构）中获取到一条消息，但还未来得及处理，该消费者出现故障，那么这条消息就会丢失，这是因为 POP 命令是 remove and get，会将消息直接从消息队列中直接移除，这样其他消费者就获取不到。</span>
            </li>
            <li><span>只支持单消费者。消息队列（List 结构）中的消息，一旦被某个消费者取走，就会从队列中移除，其他消费者就获取不到了，无法实现一条消息被很多消费者消费的需求。</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='pubsub消息队列'><span>PubSub消息队列</span></h3>
        <p><span>优点：</span></p>
        <ul>
            <li><span>采用发布订阅模型，支持多生产、多消费。一条消息可以发给多个消费者，也可以发给一个消费者，而且也支持不同生产者往相同频道发。</span></li>
        </ul>
        <p><span>缺点：</span></p>
        <ul>
            <li><span>不支持数据持久化。</span></li>
            <li><span>无法避免消息丢失</span></li>
            <li><span>消息堆积有上限，超出时数据丢失。当发送一条消息时，如果有消费者监听，消费者会将发送过来的消息缓存至消息缓存区，由消费者进行处理。而消费者的缓存空间是有上限的，如果超出了就会丢失。</span>
            </li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='stream-消息队列'><span>Stream 消息队列</span></h3>
        <p><span>优点：</span></p>
        <ul>
            <li><span>消息可回溯。消息读完后不消失，永久保存在队列中</span></li>
            <li><span>一个消息可以被多个消费者读取</span></li>
            <li><span>可以阻塞读取</span></li>
        </ul>
        <p>&nbsp;</p>
        <h3 id='rabbitmq实现'><span>rabbitMQ实现</span></h3>
        <p><span>配置：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">config</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">amqp</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">Binding</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">amqp</span>.<span class="cm-variable">core</span>.<span class="cm-variable">BindingBuilder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">amqp</span>.<span class="cm-variable">core</span>.<span class="cm-variable">DirectExchange</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">amqp</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">Queue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">amqp</span>.<span class="cm-variable">support</span>.<span class="cm-variable">converter</span>.<span
                class="cm-variable">Jackson2JsonMessageConverter</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                          role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">context</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Bean</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">context</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Configuration</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Project name(项目名称)：spring_boot_redis_hmdp_message_queue_realizes_asynchronous_spike</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Package(包名): mao.spring_boot_redis_hmdp.config</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Class(类名): RabbitMQConfig</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author(作者）: mao</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Author QQ：1296193245</span></span></pre><pre class=" CodeMirror-line "
                                                                                  role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* GitHub：https://github.com/maomao124/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">* Date(创建日期)： 2022/5/17</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Time(创建时间)： 22:23</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span
                class="cm-comment">* Version(版本): 1.0</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* Description(描述)： RabbitMQ基本配置，暂时不考虑消息丢失问题</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Configuration</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">RabbitMQConfig</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 交换机名称</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span
                class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span class="cm-variable">EXCHANGE_NAME</span> <span
                class="cm-operator">=</span> <span class="cm-string">"hmdp_exchange"</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 队列名称</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span
                class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span class="cm-variable">QUEUE_NAME</span> <span
                class="cm-operator">=</span> <span class="cm-string">"hmdp_queue"</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* routingKey</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span
                class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span class="cm-variable">ROUTING_KEY</span> <span
                class="cm-operator">=</span> <span class="cm-string">"VoucherOrder"</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 声明直接交换机</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return DirectExchange</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">DirectExchange</span> <span
                class="cm-variable">directExchange</span>()</span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-keyword">new</span> <span class="cm-variable">DirectExchange</span>(<span class="cm-variable">EXCHANGE_NAME</span>, <span
                class="cm-atom">false</span>, <span class="cm-atom">false</span>, <span
                class="cm-atom">null</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 声明队列</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return Queue</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Queue</span> <span
                class="cm-variable">queue</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-keyword">new</span> <span class="cm-variable">Queue</span>(<span class="cm-variable">QUEUE_NAME</span>, <span
                class="cm-atom">false</span>, <span class="cm-atom">false</span>, <span
                class="cm-atom">false</span>, <span class="cm-atom">null</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 绑定</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return Binding</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Binding</span> <span class="cm-variable">exchange_binding_queue</span>()</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">BindingBuilder</span>.<span
                class="cm-variable">bind</span>(<span class="cm-variable">queue</span>()).<span
                class="cm-variable">to</span>(<span class="cm-variable">directExchange</span>()).<span
                class="cm-variable">with</span>(<span class="cm-variable">ROUTING_KEY</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 使用json传递消息</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return Jackson2JsonMessageConverter</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Jackson2JsonMessageConverter</span> <span
                class="cm-variable">jackson2JsonMessageConverter</span>()</span></pre><pre class=" CodeMirror-line "
                                                                                           role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-keyword">new</span> <span
                class="cm-variable">Jackson2JsonMessageConverter</span>();</span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1955px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1955px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>业务：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">conditions</span>.<span class="cm-variable">update</span>.<span
                class="cm-variable">UpdateWrapper</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">config</span>.<span class="cm-variable">RabbitMQConfig</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">UserDTO</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">SeckillVoucher</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">VoucherOrder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">VoucherOrderMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">ISeckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IVoucherOrderService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisConstants</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisIDGenerator</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">UserHolder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span
                class="cm-variable">redisson</span>.<span class="cm-variable">api</span>.<span
                class="cm-variable">RLock</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">org</span>.<span class="cm-variable">redisson</span>.<span
                class="cm-variable">api</span>.<span class="cm-variable">RedissonClient</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">amqp</span>.<span class="cm-variable">rabbit</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">RabbitListener</span>;</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">amqp</span>.<span class="cm-variable">rabbit</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">RabbitTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">io</span>.<span class="cm-variable">ClassPathResource</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">script</span>.<span class="cm-variable">DefaultRedisScript</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">transaction</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Transactional</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">PostConstruct</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">time</span>.<span class="cm-variable">LocalDateTime</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">Collections</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">ArrayBlockingQueue</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">BlockingQueue</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">ExecutorService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">Executors</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span
                class="cm-keyword">class</span> <span class="cm-def">VoucherOrderServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">VoucherOrderMapper</span>, <span class="cm-variable">VoucherOrder</span><span
                class="cm-operator">&gt;</span> <span class="cm-keyword">implements</span> <span class="cm-variable">IVoucherOrderService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">ISeckillVoucherService</span> <span class="cm-variable">seckillVoucherService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisIDGenerator</span> <span
                class="cm-variable">redisIDGenerator</span>;</span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedissonClient</span> <span class="cm-variable">redissonClient</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RabbitTemplate</span> <span class="cm-variable">rabbitTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span
                class="cm-keyword">final</span> <span class="cm-variable">DefaultRedisScript</span><span
                class="cm-operator">&lt;</span><span class="cm-variable-3">Long</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">SECKILL_SCRIPT</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 阻塞队列</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">final</span> <span class="cm-variable">BlockingQueue</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">VoucherOrder</span><span class="cm-operator">&gt;</span> <span class="cm-variable">blockingQueue</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ArrayBlockingQueue</span><span
                class="cm-operator">&lt;&gt;</span>(<span class="cm-number">1024</span> <span
                class="cm-operator">*</span> <span class="cm-number">1024</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 线程池</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable">ExecutorService</span> <span
                class="cm-variable">SECKILL_ORDER_EXECUTOR</span> <span class="cm-operator">=</span> <span
                class="cm-variable">Executors</span>.<span class="cm-variable">newSingleThreadExecutor</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">static</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//创建对象</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">SECKILL_SCRIPT</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">DefaultRedisScript</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//加载</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SECKILL_SCRIPT</span>.<span
                class="cm-variable">setLocation</span>(<span class="cm-keyword">new</span> <span class="cm-variable">ClassPathResource</span>(<span
                class="cm-string">"seckill.lua"</span>));</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//设置返回类型</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SECKILL_SCRIPT</span>.<span
                class="cm-variable">setResultType</span>(<span class="cm-variable-3">Long</span>.<span
                class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@PostConstruct</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span
                class="cm-variable">init</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SECKILL_ORDER_EXECUTOR</span>.<span
                class="cm-variable">submit</span>((<span class="cm-variable">Runnable</span>) <span class="cm-variable">VoucherOrderHandler</span>::<span
                class="cm-keyword">new</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">private</span> <span class="cm-keyword">class</span> <span class="cm-def">VoucherOrderHandler</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">Runnable</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span
                class="cm-variable-3">void</span> <span class="cm-variable">run</span>()</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//系统启动开始，便不断从阻塞队列中获取优惠券订单信息</span></span></pre><pre class=" CodeMirror-line "
                                                                                       role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">while</span> (<span class="cm-atom">true</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取订单信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span> <span
                class="cm-operator">=</span> <span class="cm-variable">blockingQueue</span>.<span class="cm-variable">take</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">voucherOrder</span>);</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">debug</span>(<span class="cm-string">"异步订单创建任务执行成功！订单id："</span> <span
                class="cm-operator">+</span> <span class="cm-variable">voucherOrder</span>.<span class="cm-variable">getVoucherId</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span
                class="cm-variable">e</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  @Override</span></span></pre><pre class=" CodeMirror-line "
                                                                                role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp;  public Result seckillVoucher(Long voucherId)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //查询优惠券</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  SeckillVoucher seckillVoucher = seckillVoucherService.getById(voucherId);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断是否存在</span></span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (seckillVoucher == null)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("活动不存在");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断是否开始</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (seckillVoucher.getBeginTime().isAfter(LocalDateTime.now()))</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //未开始</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("秒杀活动未开始");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断是否结束</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (seckillVoucher.getEndTime().isBefore(LocalDateTime.now()))</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //结束</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("秒杀活动已经结束");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断库存是否充足</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (seckillVoucher.getStock() &lt;= 0)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //库存不足</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("库存不足");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //创建订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  return this.createVoucherOrder(voucherId);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"><span
                class="cm-comment">//</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  /**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; * 创建订单</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; *</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; * @param voucherId voucherId</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; * @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; */</span></span></pre><pre class=" CodeMirror-line "
                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  @Transactional</span></span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp;  public Result createVoucherOrder(Long voucherId)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断当前优惠券用户是否已经下过单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //获得用户id</span></span></pre><pre class=" CodeMirror-line "
                                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  Long userID = 5L;</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //todo:记得更改回来</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  /*//创建锁对象</span></span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  RedisLock redisLock = new RedisLockImpl("order:" + userID, stringRedisTemplate);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //取得锁</span></span></pre><pre class=" CodeMirror-line "
                                                                                          role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  boolean isLock = redisLock.tryLock(1500);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断</span></span></pre><pre class=" CodeMirror-line "
                                                                                         role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (!isLock)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("不允许重复下单！");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }*/</span></span></pre><pre class=" CodeMirror-line "
                                                                                        role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">//</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //redisson锁</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  RLock lock = redissonClient.getLock("lock:order:" + userID);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //尝试获取锁</span></span></pre><pre class=" CodeMirror-line "
                                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //仅当调用时它是空闲的时才获取锁。</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //如果锁可用，则获取锁并立即返回值为true</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //如果锁不可用，则此方法将立即返回值false</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  boolean tryLock = lock.tryLock();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //判断是否获取成功</span></span></pre><pre class=" CodeMirror-line "
                                                                                               role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  if (!tryLock)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("不允许重复下单！");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  //获取锁成功</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  //synchronized (userID.toString().intern())</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  try</span></span></pre><pre class=" CodeMirror-line "
                                                                                        role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //查询数据库</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Long count = this.query().eq("user_id", userID).eq("voucher_id", voucherId).count();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //判断长度</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  if (count &gt; 0)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //长度大于0，用户购买过</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("不能重复下单");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //扣减库存</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  UpdateWrapper&lt;SeckillVoucher&gt; updateWrapper = new UpdateWrapper&lt;&gt;();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  updateWrapper.setSql("stock = stock - 1").eq("voucher_id", voucherId).gt("stock", 0);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  boolean update = seckillVoucherService.update(updateWrapper);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  if (!update)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //失败</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.fail("库存扣减失败");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //扣减成功</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //生成订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  VoucherOrder voucherOrder = new VoucherOrder();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //生成id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Long orderID = redisIDGenerator.nextID("order");</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  voucherOrder.setVoucherId(voucherId);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  voucherOrder.setId(orderID);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //设置用户</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  voucherOrder.setUserId(userID);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //保存订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  this.save(voucherOrder);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //返回</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  return Result.ok(orderID);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp;  finally</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  {</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //释放锁</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  //redisLock.unlock();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  lock.unlock();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp; &nbsp; &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                                      role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span
                class="cm-comment">// &nbsp;  }</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 处理消息的方法，创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param voucherOrder voucherOrder</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@RabbitListener</span>(<span class="cm-variable">queues</span> <span
                class="cm-operator">=</span> {<span class="cm-variable">RabbitMQConfig</span>.<span class="cm-variable">QUEUE_NAME</span>})</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">handleMessage</span>(<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">voucherOrder</span>);</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">log</span>.<span class="cm-variable">debug</span>(<span class="cm-string">"异步订单创建任务执行成功！订单id："</span> <span
                class="cm-operator">+</span> <span class="cm-variable">voucherOrder</span>.<span class="cm-variable">getVoucherId</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">seckillVoucher</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">s</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForValue</span>().<span class="cm-variable">get</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">SECKILL_STOCK_KEY</span> <span class="cm-operator">+</span> <span
                class="cm-variable">voucherId</span>);</span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断此优惠券是否存在</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">s</span> <span
                class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"此优惠券不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UserDTO</span> <span class="cm-variable">user</span> <span
                class="cm-operator">=</span> <span class="cm-variable">UserHolder</span>.<span class="cm-variable">getUser</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得用户ID</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//Long userID = user.getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userID</span> <span
                class="cm-operator">=</span> <span class="cm-number">5L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//todo:记得更改</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//执行lua脚本</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">result</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">execute</span>(<span class="cm-variable">SECKILL_SCRIPT</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Collections</span>.<span class="cm-variable">emptyList</span>(),</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherId</span>.<span class="cm-variable">toString</span>(), <span
                class="cm-variable">userID</span>.<span class="cm-variable">toString</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">result</span> <span
                class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"订单异常"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 判断结果是否为 0</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">result</span> <span
                class="cm-operator">!=</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 不为 0 ，代表没有购买资格</span></span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Result</span>.<span class="cm-variable">fail</span>(<span
                class="cm-variable">result</span> <span class="cm-operator">==</span> <span
                class="cm-number">1</span> <span class="cm-operator">?</span> <span
                class="cm-string">"库存不足！"</span> : <span class="cm-string">"不能重复下单!"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//为0，创建订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">orderId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redisIDGenerator</span>.<span
                class="cm-variable">nextID</span>(<span class="cm-string">"oder"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">VoucherOrder</span>();</span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">voucherOrder</span>.<span
                class="cm-variable">setVoucherId</span>(<span class="cm-variable">voucherId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">voucherOrder</span>.<span class="cm-variable">setUserId</span>(<span
                class="cm-variable">userID</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">voucherOrder</span>.<span
                class="cm-variable">setId</span>(<span class="cm-variable">orderId</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//加入到阻塞队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//blockingQueue.add(voucherOrder);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//加入到消息队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">rabbitTemplate</span>.<span
                class="cm-variable">convertAndSend</span>(<span class="cm-variable">RabbitMQConfig</span>.<span
                class="cm-variable">EXCHANGE_NAME</span>, <span class="cm-variable">RabbitMQConfig</span>.<span
                class="cm-variable">ROUTING_KEY</span>, <span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Result</span>.<span class="cm-variable">ok</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 创建订单</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param voucherOrder VoucherOrder</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Transactional</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">protected</span> <span class="cm-variable-3">void</span> <span class="cm-variable">createVoucherOrder</span>(<span
                class="cm-variable">VoucherOrder</span> <span class="cm-variable">voucherOrder</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断当前优惠券用户是否已经下过单</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获得用户id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//Long userID = UserHolder.getUser().getId();</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userID</span> <span
                class="cm-operator">=</span> <span class="cm-number">5L</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//todo:记得更改回来</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">/*//创建锁对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">RedisLock redisLock = new RedisLockImpl("order:" + userID, stringRedisTemplate);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//取得锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">boolean isLock = redisLock.tryLock(1500);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">if (!isLock)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">return Result.fail("不允许重复下单！");</span></span></pre><pre class=" CodeMirror-line "
                                                                                           role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">}*/</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//redisson锁</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RLock</span> <span class="cm-variable">lock</span> <span
                class="cm-operator">=</span> <span class="cm-variable">redissonClient</span>.<span class="cm-variable">getLock</span>(<span
                class="cm-string">"lock:order:"</span> <span class="cm-operator">+</span> <span class="cm-variable">userID</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//尝试获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//仅当调用时它是空闲的时才获取锁。</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//如果锁可用，则获取锁并立即返回值为true</span></span></pre><pre class=" CodeMirror-line "
                                                                                   role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//如果锁不可用，则此方法将立即返回值false</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">tryLock</span> <span class="cm-operator">=</span> <span
                class="cm-variable">lock</span>.<span class="cm-variable">tryLock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否获取成功</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">tryLock</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取锁成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//synchronized (userID.toString().intern())</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">voucherId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">voucherOrder</span>.<span class="cm-variable">getVoucherId</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">count</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">query</span>().<span
                class="cm-variable">eq</span>(<span class="cm-string">"user_id"</span>, <span
                class="cm-variable">userID</span>).<span class="cm-variable">eq</span>(<span class="cm-string">"voucher_id"</span>, <span
                class="cm-variable">voucherId</span>).<span class="cm-variable">count</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断长度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">count</span> <span
                class="cm-operator">&gt;</span> <span class="cm-number">0</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//长度大于0，用户购买过</span></span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减库存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;</span><span class="cm-variable">SeckillVoucher</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">updateWrapper</span> <span
                class="cm-operator">=</span> <span class="cm-keyword">new</span> <span
                class="cm-variable">UpdateWrapper</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">updateWrapper</span>.<span class="cm-variable">setSql</span>(<span
                class="cm-string">"stock = stock - 1"</span>).<span class="cm-variable">eq</span>(<span
                class="cm-string">"voucher_id"</span>, <span class="cm-variable">voucherId</span>).<span
                class="cm-variable">gt</span>(<span class="cm-string">"stock"</span>, <span class="cm-number">0</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">seckillVoucherService</span>.<span
                class="cm-variable">update</span>(<span class="cm-variable">updateWrapper</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//扣减成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存订单</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">this</span>.<span class="cm-variable">save</span>(<span class="cm-variable">voucherOrder</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">finally</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//redisLock.unlock();</span></span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">lock</span>.<span class="cm-variable">unlock</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 8004px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 8004px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h1 id='达人探店'><span>达人探店</span></h1>
        <h2 id='查询探店笔记'><span>查询探店笔记</span></h2>
        <p><span>controller：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div
                class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"> <span class="cm-tab"
                                                                                                         role="presentation"
                                                                                                         cm-text="	">   </span><span
                class="cm-meta">@GetMapping</span>(<span class="cm-string">"/hot"</span>)</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-def">queryHotBlog</span>(<span
                class="cm-meta">@RequestParam</span>(<span class="cm-variable">value</span> <span
                class="cm-operator">=</span> <span class="cm-string">"current"</span>, <span class="cm-variable">defaultValue</span> <span
                class="cm-operator">=</span> <span class="cm-string">"1"</span>) <span
                class="cm-variable-3">Integer</span> <span class="cm-variable">current</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">blogService</span>.<span class="cm-variable">queryHotBlog</span>(<span
                class="cm-variable">current</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@GetMapping</span>(<span class="cm-string">"/{id}"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-def">queryBlogById</span>(<span
                class="cm-meta">@PathVariable</span>(<span class="cm-string">"id"</span>) <span class="cm-variable-3">String</span> <span
                class="cm-variable">id</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">blogService</span>.<span class="cm-variable">queryBlogById</span>(<span
                class="cm-variable">id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 253px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 253px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>接口：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>;</span></pre></div><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">IService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">Blog</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">IBlogService</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">IService</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">Blog</span><span class="cm-operator">&gt;</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 查询热门的探店笔记</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param current 当前页</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Result</span> <span
                class="cm-variable">queryHotBlog</span>(<span class="cm-variable-3">Integer</span> <span
                class="cm-variable">current</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 根据id进行查询</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return Result</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Result</span> <span
                class="cm-variable">queryBlogById</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 621px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 621px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>实现：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">plugins</span>.<span class="cm-variable">pagination</span>.<span
                class="cm-variable">Page</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">com</span>.<span class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">Blog</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">User</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">BlogMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IBlogService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IUserService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisConstants</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisUtils</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">SystemConstants</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">List</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">TimeUnit</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span>(<span class="cm-string">"blogService"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">BlogServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">BlogMapper</span>, <span class="cm-variable">Blog</span><span class="cm-operator">&gt;</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">IBlogService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">IUserService</span> <span class="cm-variable">userService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisUtils</span> <span class="cm-variable">redisUtils</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">queryHotBlog</span>(<span
                class="cm-variable-3">Integer</span> <span class="cm-variable">current</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 根据用户查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Page</span><span
                class="cm-operator">&lt;</span><span class="cm-variable">Blog</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">page</span> <span class="cm-operator">=</span> <span
                class="cm-variable">query</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span
                class="cm-variable">orderByDesc</span>(<span class="cm-string">"liked"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span
                class="cm-variable">page</span>(<span class="cm-keyword">new</span> <span
                class="cm-variable">Page</span><span class="cm-operator">&lt;&gt;</span>(<span class="cm-variable">current</span>, <span
                class="cm-variable">SystemConstants</span>.<span
                class="cm-variable">MAX_PAGE_SIZE</span>));</span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 获取当前页数据</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">List</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">Blog</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">records</span> <span class="cm-operator">=</span> <span
                class="cm-variable">page</span>.<span class="cm-variable">getRecords</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 查询用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">records</span>.<span
                class="cm-variable">forEach</span>(<span class="cm-variable">blog</span> <span
                class="cm-operator">-&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">blog</span>.<span
                class="cm-variable">getUserId</span>();</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">User</span> <span class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">userService</span>.<span class="cm-variable">getById</span>(<span
                class="cm-variable">userId</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setName</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getNickName</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setIcon</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getIcon</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  });</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">records</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">queryBlogById</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">id</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//Blog blog = this.getById(id);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Blog</span> <span class="cm-variable">blog</span> <span class="cm-operator">=</span> <span
                class="cm-variable">redisUtils</span>.<span class="cm-variable">query</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">BLOG_KEY</span>,</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">LOCK_BLOG_KEY</span>, <span
                class="cm-variable">id</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Blog</span>.<span class="cm-keyword">class</span>, <span
                class="cm-keyword">this</span>::<span class="cm-variable">getById</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">CACHE_BLOG_TTL</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">MINUTES</span>, <span class="cm-number">120</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">blog</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不存在，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"该笔记信息不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//填充用户信息</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得用户id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">blog</span>.<span
                class="cm-variable">getUserId</span>();</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">User</span> <span
                class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">userService</span>.<span class="cm-variable">getById</span>(<span
                class="cm-variable">userId</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//填充</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setIcon</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getIcon</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setName</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getNickName</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Result</span>.<span class="cm-variable">ok</span>(<span
                class="cm-variable">blog</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1863px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 1863px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h2 id='实现点赞功能'><span>实现点赞功能</span></h2>
        <p>&nbsp;</p>
        <p><span>controller：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div
                class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span><span
                class="cm-meta">@PutMapping</span>(<span class="cm-string">"/like/{id}"</span>)</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span
                class="cm-def">likeBlog</span>(<span class="cm-meta">@PathVariable</span>(<span
                class="cm-string">"id"</span>) <span class="cm-variable-3">Long</span> <span
                class="cm-variable">id</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">blogService</span>.<span class="cm-variable">likeBlog</span>(<span
                class="cm-variable">id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>接口：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>;</span></pre></div><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">IService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">Blog</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">IBlogService</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">IService</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">Blog</span><span class="cm-operator">&gt;</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 查询热门的探店笔记</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param current 当前页</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Result</span> <span
                class="cm-variable">queryHotBlog</span>(<span class="cm-variable-3">Integer</span> <span
                class="cm-variable">current</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 根据id进行查询</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return Result</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Result</span> <span
                class="cm-variable">queryBlogById</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 点赞功能</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return result</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Result</span> <span
                class="cm-variable">likeBlog</span>(<span class="cm-variable-3">Long</span> <span
                class="cm-variable">id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 782px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 782px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>实现：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">BooleanUtil</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">conditions</span>.<span class="cm-variable">update</span>.<span
                class="cm-variable">UpdateWrapper</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">plugins</span>.<span class="cm-variable">pagination</span>.<span
                class="cm-variable">Page</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">com</span>.<span class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">UserDTO</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">Blog</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">User</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">BlogMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IBlogService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IUserService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisConstants</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisUtils</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">SystemConstants</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">UserHolder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">List</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">TimeUnit</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span>(<span class="cm-string">"blogService"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">BlogServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">BlogMapper</span>, <span class="cm-variable">Blog</span><span class="cm-operator">&gt;</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">IBlogService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">IUserService</span> <span class="cm-variable">userService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisUtils</span> <span class="cm-variable">redisUtils</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">queryHotBlog</span>(<span
                class="cm-variable-3">Integer</span> <span class="cm-variable">current</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 根据用户查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Page</span><span
                class="cm-operator">&lt;</span><span class="cm-variable">Blog</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">page</span> <span class="cm-operator">=</span> <span
                class="cm-variable">query</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span
                class="cm-variable">orderByDesc</span>(<span class="cm-string">"liked"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span
                class="cm-variable">page</span>(<span class="cm-keyword">new</span> <span
                class="cm-variable">Page</span><span class="cm-operator">&lt;&gt;</span>(<span class="cm-variable">current</span>, <span
                class="cm-variable">SystemConstants</span>.<span
                class="cm-variable">MAX_PAGE_SIZE</span>));</span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 获取当前页数据</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">List</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">Blog</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">records</span> <span class="cm-operator">=</span> <span
                class="cm-variable">page</span>.<span class="cm-variable">getRecords</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 查询用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">records</span>.<span
                class="cm-variable">forEach</span>(<span class="cm-variable">blog</span> <span
                class="cm-operator">-&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">blog</span>.<span
                class="cm-variable">getUserId</span>();</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">User</span> <span class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">userService</span>.<span class="cm-variable">getById</span>(<span
                class="cm-variable">userId</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setName</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getNickName</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setIcon</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getIcon</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  });</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">records</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">queryBlogById</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">id</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//Blog blog = this.getById(id);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Blog</span> <span class="cm-variable">blog</span> <span class="cm-operator">=</span> <span
                class="cm-variable">redisUtils</span>.<span class="cm-variable">query</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">BLOG_KEY</span>,</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">LOCK_BLOG_KEY</span>, <span
                class="cm-variable">id</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Blog</span>.<span class="cm-keyword">class</span>, <span
                class="cm-keyword">this</span>::<span class="cm-variable">getById</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">CACHE_BLOG_TTL</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">MINUTES</span>, <span class="cm-number">120</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">blog</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不存在，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"该笔记信息不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//填充用户信息</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得用户id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">blog</span>.<span
                class="cm-variable">getUserId</span>();</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">User</span> <span
                class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">userService</span>.<span class="cm-variable">getById</span>(<span
                class="cm-variable">userId</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//填充</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setIcon</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getIcon</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setName</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getNickName</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Result</span>.<span class="cm-variable">ok</span>(<span
                class="cm-variable">blog</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">likeBlog</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">id</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取用户信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UserDTO</span> <span
                class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">UserHolder</span>.<span class="cm-variable">getUser</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断用户是否已经点赞(检查设置在key是否包含value)</span></span></pre><pre class=" CodeMirror-line "
                                                                                           role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Boolean</span> <span class="cm-variable">member</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForSet</span>().<span class="cm-variable">isMember</span>(<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">BLOG_LIKED_KEY</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>, <span class="cm-variable">user</span>.<span
                class="cm-variable">getId</span>().<span class="cm-variable">toString</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">BooleanUtil</span>.<span class="cm-variable">isFalse</span>(<span
                class="cm-variable">member</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//未点赞</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库点赞数量+1</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">update</span>().<span
                class="cm-variable">setSql</span>(<span class="cm-string">"liked = liked + 1"</span>).<span
                class="cm-variable">eq</span>(<span class="cm-string">"id"</span>, <span class="cm-variable">id</span>).<span
                class="cm-variable">update</span>();</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//让redis数据过期</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">BLOG_KEY</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存用户到Redis的set集合</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">opsForSet</span>().<span
                class="cm-variable">add</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">BLOG_LIKED_KEY</span> <span class="cm-operator">+</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">user</span>.<span class="cm-variable">getId</span>().<span class="cm-variable">toString</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//已点赞，取消点赞</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库点赞数量-1</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">update</span>().<span
                class="cm-variable">setSql</span>(<span class="cm-string">"liked = liked - 1"</span>).<span
                class="cm-variable">eq</span>(<span class="cm-string">"id"</span>, <span class="cm-variable">id</span>).<span
                class="cm-variable">update</span>();</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//让redis数据过期</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">BLOG_KEY</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//移除用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">BLOG_LIKED_KEY</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3013px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 3013px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <h2 id='实现点赞排行榜'><span>实现点赞排行榜</span></h2>
        <p><span>controller：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div
                class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span class="cm-tab"
                                                                                                        role="presentation"
                                                                                                        cm-text="	">    </span><span
                class="cm-meta">@GetMapping</span>(<span class="cm-string">"/likes/{id}"</span>)</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-def">queryBlogLikes</span>(<span
                class="cm-meta">@PathVariable</span>(<span class="cm-string">"id"</span>) <span class="cm-variable-3">String</span> <span
                class="cm-variable">id</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">blogService</span>.<span class="cm-variable">queryBlogLikes</span>(<span
                class="cm-variable">id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>接口：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>;</span></pre></div><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">IService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">Blog</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">IBlogService</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">IService</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">Blog</span><span class="cm-operator">&gt;</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 查询热门的探店笔记</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param current 当前页</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @return Result</span></span></pre><pre class=" CodeMirror-line "
                                                                            role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Result</span> <span
                class="cm-variable">queryHotBlog</span>(<span class="cm-variable-3">Integer</span> <span
                class="cm-variable">current</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* 根据id进行查询</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return Result</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Result</span> <span
                class="cm-variable">queryBlogById</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 点赞功能</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return result</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Result</span> <span
                class="cm-variable">likeBlog</span>(<span class="cm-variable-3">Long</span> <span
                class="cm-variable">id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 点赞排行榜</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">* @param id id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return Result</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span
                class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Result</span> <span
                class="cm-variable">queryBlogLikes</span>(<span class="cm-variable-3">String</span> <span
                class="cm-variable">id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line "
                                                                                     role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 989px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 989px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p><span>实现类：</span></p>
        <pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"
             style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap"
                                               lang="java"><div
                style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea
                autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0"
                style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div
                class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler"
                                                                                     cm-not-content="true"></div><div
                class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer"
                                                             style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div
                style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div
                role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div
                class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div
                class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline"
                                                                          style="position: relative;"><div
                class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div
                class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">package</span> <span class="cm-def">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">impl</span>;</span></pre></div><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">bean</span>.<span class="cm-variable">BeanUtil</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">BooleanUtil</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span
                class="cm-variable">hutool</span>.<span class="cm-variable">core</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">StrUtil</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">conditions</span>.<span class="cm-variable">update</span>.<span
                class="cm-variable">UpdateWrapper</span>;</span></pre><pre class=" CodeMirror-line "
                                                                           role="presentation"><span role="presentation"
                                                                                                     style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span
                class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">plugins</span>.<span class="cm-variable">pagination</span>.<span
                class="cm-variable">Page</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span
                class="cm-variable">com</span>.<span class="cm-variable">baomidou</span>.<span class="cm-variable">mybatisplus</span>.<span
                class="cm-variable">extension</span>.<span class="cm-variable">service</span>.<span class="cm-variable">impl</span>.<span
                class="cm-variable">ServiceImpl</span>;</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">Result</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">dto</span>.<span class="cm-variable">UserDTO</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">Blog</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">entity</span>.<span class="cm-variable">User</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">mapper</span>.<span class="cm-variable">BlogMapper</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IBlogService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">service</span>.<span class="cm-variable">IUserService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisConstants</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">RedisUtils</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">SystemConstants</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">mao</span>.<span class="cm-variable">spring_boot_redis_hmdp</span>.<span
                class="cm-variable">utils</span>.<span class="cm-variable">UserHolder</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span
                class="cm-variable">core</span>.<span class="cm-variable">StringRedisTemplate</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span
                class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span
                class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">Collections</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">List</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">Set</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">TimeUnit</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span
                class="cm-variable">util</span>.<span class="cm-variable">stream</span>.<span class="cm-variable">Collectors</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"><span
                class="cm-meta">@Service</span>(<span class="cm-string">"blogService"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span
                class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">BlogServiceImpl</span> <span
                class="cm-keyword">extends</span> <span class="cm-variable">ServiceImpl</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">BlogMapper</span>, <span class="cm-variable">Blog</span><span class="cm-operator">&gt;</span> <span
                class="cm-keyword">implements</span> <span class="cm-variable">IBlogService</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">{</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">IUserService</span> <span class="cm-variable">userService</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">RedisUtils</span> <span class="cm-variable">redisUtils</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span
                class="cm-variable">StringRedisTemplate</span> <span
                class="cm-variable">stringRedisTemplate</span>;</span></pre><pre class=" CodeMirror-line "
                                                                                 role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">queryHotBlog</span>(<span
                class="cm-variable-3">Integer</span> <span class="cm-variable">current</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 根据用户查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Page</span><span
                class="cm-operator">&lt;</span><span class="cm-variable">Blog</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">page</span> <span class="cm-operator">=</span> <span
                class="cm-variable">query</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation"
                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span
                class="cm-variable">orderByDesc</span>(<span class="cm-string">"liked"</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span
                class="cm-variable">page</span>(<span class="cm-keyword">new</span> <span
                class="cm-variable">Page</span><span class="cm-operator">&lt;&gt;</span>(<span class="cm-variable">current</span>, <span
                class="cm-variable">SystemConstants</span>.<span
                class="cm-variable">MAX_PAGE_SIZE</span>));</span></pre><pre class=" CodeMirror-line "
                                                                             role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 获取当前页数据</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">List</span><span class="cm-operator">&lt;</span><span
                class="cm-variable">Blog</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">records</span> <span class="cm-operator">=</span> <span
                class="cm-variable">page</span>.<span class="cm-variable">getRecords</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">// 查询用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">records</span>.<span
                class="cm-variable">forEach</span>(<span class="cm-variable">blog</span> <span
                class="cm-operator">-&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">blog</span>.<span
                class="cm-variable">getUserId</span>();</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">User</span> <span class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">userService</span>.<span class="cm-variable">getById</span>(<span
                class="cm-variable">userId</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setName</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getNickName</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setIcon</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getIcon</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  });</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">records</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">queryBlogById</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">id</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//Blog blog = this.getById(id);</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Blog</span> <span class="cm-variable">blog</span> <span class="cm-operator">=</span> <span
                class="cm-variable">redisUtils</span>.<span class="cm-variable">query</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">BLOG_KEY</span>,</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">LOCK_BLOG_KEY</span>, <span
                class="cm-variable">id</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Blog</span>.<span class="cm-keyword">class</span>, <span
                class="cm-keyword">this</span>::<span class="cm-variable">getById</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">CACHE_BLOG_TTL</span>,</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">TimeUnit</span>.<span class="cm-variable">MINUTES</span>, <span class="cm-number">120</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">blog</span> <span class="cm-operator">==</span> <span
                class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//不存在，返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">fail</span>(<span class="cm-string">"该笔记信息不存在"</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//填充用户信息</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得用户id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Long</span> <span class="cm-variable">userId</span> <span
                class="cm-operator">=</span> <span class="cm-variable">blog</span>.<span
                class="cm-variable">getUserId</span>();</span></pre><pre class=" CodeMirror-line "
                                                                         role="presentation"><span role="presentation"
                                                                                                   style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">User</span> <span
                class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">userService</span>.<span class="cm-variable">getById</span>(<span
                class="cm-variable">userId</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//填充</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setIcon</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getIcon</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">blog</span>.<span class="cm-variable">setName</span>(<span
                class="cm-variable">user</span>.<span class="cm-variable">getNickName</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Result</span>.<span class="cm-variable">ok</span>(<span
                class="cm-variable">blog</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">likeBlog</span>(<span
                class="cm-variable-3">Long</span> <span class="cm-variable">id</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获取用户信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UserDTO</span> <span
                class="cm-variable">user</span> <span class="cm-operator">=</span> <span
                class="cm-variable">UserHolder</span>.<span class="cm-variable">getUser</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断用户是否已经点赞(检查设置在key是否包含value)</span></span></pre><pre class=" CodeMirror-line "
                                                                                           role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">Boolean</span> <span class="cm-variable">member</span> <span
                class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForSet</span>().<span class="cm-variable">isMember</span>(<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">BLOG_LIKED_KEY</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>, <span class="cm-variable">user</span>.<span
                class="cm-variable">getId</span>().<span class="cm-variable">toString</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">BooleanUtil</span>.<span class="cm-variable">isFalse</span>(<span
                class="cm-variable">member</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//未点赞</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库点赞数量+1</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">update</span>().<span
                class="cm-variable">setSql</span>(<span class="cm-string">"liked = liked + 1"</span>).<span
                class="cm-variable">eq</span>(<span class="cm-string">"id"</span>, <span class="cm-variable">id</span>).<span
                class="cm-variable">update</span>();</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//让redis数据过期</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">BLOG_KEY</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//保存用户到Redis的set集合</span></span></pre><pre class=" CodeMirror-line "
                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">opsForSet</span>().<span
                class="cm-variable">add</span>(<span class="cm-variable">RedisConstants</span>.<span
                class="cm-variable">BLOG_LIKED_KEY</span> <span class="cm-operator">+</span> <span class="cm-variable">id</span>, <span
                class="cm-variable">user</span>.<span class="cm-variable">getId</span>().<span class="cm-variable">toString</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//已点赞，取消点赞</span></span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//数据库点赞数量-1</span></span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">boolean</span> <span class="cm-variable">update</span> <span
                class="cm-operator">=</span> <span class="cm-variable">update</span>().<span
                class="cm-variable">setSql</span>(<span class="cm-string">"liked = liked - 1"</span>).<span
                class="cm-variable">eq</span>(<span class="cm-string">"id"</span>, <span class="cm-variable">id</span>).<span
                class="cm-variable">update</span>();</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断是否成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">if</span> (<span class="cm-variable">update</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//让redis数据过期</span></span></pre><pre class=" CodeMirror-line "
                                                                        role="presentation"><span role="presentation"
                                                                                                  style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">BLOG_KEY</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//移除用户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">stringRedisTemplate</span>.<span class="cm-variable">delete</span>(<span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">BLOG_LIKED_KEY</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line "
                                                                                              role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                             style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span
                class="cm-keyword">public</span> <span class="cm-variable">Result</span> <span class="cm-variable">queryBlogLikes</span>(<span
                class="cm-variable-3">String</span> <span class="cm-variable">id</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//获得key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span
                class="cm-variable">RedisConstants</span>.<span class="cm-variable">BLOG_LIKED_KEY</span> <span
                class="cm-operator">+</span> <span class="cm-variable">id</span>;</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询前5名的点赞的用户(从排序集中获取start和end之间的元素)</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">Set</span><span class="cm-operator">&lt;</span><span
                class="cm-variable-3">String</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">range</span> <span class="cm-operator">=</span> <span class="cm-variable">stringRedisTemplate</span>.<span
                class="cm-variable">opsForZSet</span>().<span class="cm-variable">range</span>(<span
                class="cm-variable">redisKey</span>, <span class="cm-number">0</span>, <span class="cm-number">4</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//判断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span
                class="cm-variable">range</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回空集合</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-keyword">return</span> <span class="cm-variable">Result</span>.<span
                class="cm-variable">ok</span>(<span class="cm-variable">Collections</span>.<span class="cm-variable">emptyList</span>());</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//非空</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//解析出用户的id</span></span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">List</span><span class="cm-operator">&lt;</span><span
                class="cm-variable-3">Long</span><span class="cm-operator">&gt;</span> <span
                class="cm-variable">ids</span> <span class="cm-operator">=</span> <span class="cm-variable">range</span>.<span
                class="cm-variable">stream</span>().<span class="cm-variable">map</span>(<span class="cm-variable-3">Long</span>::<span
                class="cm-variable">valueOf</span>).<span class="cm-variable">collect</span>(<span class="cm-variable">Collectors</span>.<span
                class="cm-variable">toList</span>());</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//拼接</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable-3">String</span> <span class="cm-variable">join</span> <span
                class="cm-operator">=</span> <span class="cm-variable">StrUtil</span>.<span
                class="cm-variable">join</span>(<span class="cm-string">","</span>, <span class="cm-variable">ids</span>);</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//查询数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">List</span><span
                class="cm-operator">&lt;</span><span class="cm-variable">User</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">users</span> <span
                class="cm-operator">=</span> <span class="cm-variable">userService</span>.<span class="cm-variable">query</span>().<span
                class="cm-variable">in</span>(<span class="cm-string">"id"</span>, <span class="cm-variable">ids</span>).<span
                class="cm-variable">last</span>(<span class="cm-string">"order by filed(id, "</span> <span
                class="cm-operator">+</span> <span class="cm-variable">join</span> <span
                class="cm-operator">+</span> <span class="cm-string">")"</span>).<span class="cm-variable">list</span>();</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//转换成dto</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">List</span><span
                class="cm-operator">&lt;</span><span class="cm-variable">UserDTO</span><span
                class="cm-operator">&gt;</span> <span class="cm-variable">dtoList</span> <span
                class="cm-operator">=</span> <span class="cm-variable">users</span>.<span
                class="cm-variable">stream</span>().<span class="cm-variable">map</span>(<span
                class="cm-variable">user</span> <span class="cm-operator">-&gt;</span> <span class="cm-variable">BeanUtil</span>.<span
                class="cm-variable">copyProperties</span>(<span class="cm-variable">user</span>, <span
                class="cm-variable">UserDTO</span>.<span class="cm-keyword">class</span>)).</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-variable">collect</span>(<span class="cm-variable">Collectors</span>.<span
                class="cm-variable">toList</span>());</span></pre><pre class=" CodeMirror-line "
                                                                       role="presentation"><span role="presentation"
                                                                                                 style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span
                class="cm-comment">//返回数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span
                role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span
                class="cm-variable">Result</span>.<span class="cm-variable">ok</span>(<span
                class="cm-variable">dtoList</span>);</span></pre><pre class=" CodeMirror-line "
                                                                      role="presentation"><span role="presentation"
                                                                                                style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;">}</span></pre><pre
                class=" CodeMirror-line " role="presentation"><span role="presentation"
                                                                    style="padding-right: 0.1px;"><span cm-text=""
                                                                                                        cm-zwsp="">
</span></span></pre></div></div></div></div></div><div
                style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3749px;"></div><div
                class="CodeMirror-gutters" style="display: none; height: 3749px;"></div></div></div></pre>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <h1 id='关注'><span>关注</span></h1>
        <h2 id='关注和取消关注'><span>关注和取消关注</span></h2>
        <p>&nbsp;</p></div>
</div>
</body>
</html>